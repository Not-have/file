# å‰ç«¯é¡¹ç›®æ­å»º - å¾®ä¿¡å°ç¨‹åºï¼ˆä¼é¹…è¯»ä¼´é¡¹ç›®æŠ€æœ¯æ–¹æ¡ˆï¼‰

é¢å‘ä» 0 åˆ°ä¸Šçº¿çš„å¾®ä¿¡å°ç¨‹åºæ­å»ºè¯´æ˜ï¼Œè¦†ç›–ç›®å½•è§„èŒƒã€ç½‘ç»œä¸å®‰å…¨ã€æ€§èƒ½ä¸åŠ¨æ•ˆã€è°ƒè¯•æµ‹è¯•ã€å‘å¸ƒéªŒæ”¶ç­‰å…³é”®ç¯èŠ‚ï¼Œæ»¡è¶³æ— ç½‘ç»œç¼“å­˜ã€å¼±ç½‘å…œåº•ã€ç½‘ç»œå­—ä½“/å›¾ç‰‡é™åˆ¶ç­‰éœ€æ±‚ã€‚

**æœ¬æ–‡æ¡£åŸºäºã€Œä¼é¹…è¯»ä¼´ã€é¡¹ç›®ä¸šåŠ¡éœ€æ±‚ï¼Œæä¾›å®Œæ•´çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆã€‚**

---

## 0. é¡¹ç›®æ¦‚è¿°ä¸ä¸šåŠ¡éœ€æ±‚åˆ†æ

### 0.1 é¡¹ç›®èƒŒæ™¯

ã€Œä¼é¹…è¯»ä¼´ã€æ˜¯ä¸€æ¬¾é¢å‘é’å°‘å¹´çš„æ™ºèƒ½é˜…è¯»é™ªä¼´å°ç¨‹åºï¼Œé€šè¿‡ AI æŠ€æœ¯æä¾›èŠä¹¦ã€æ¨ä¹¦ã€åˆ›ä½œã€éŸ³è‰²å®šåˆ¶ç­‰åŠŸèƒ½ï¼Œæ‰“é€ æ²‰æµ¸å¼ã€äº’åŠ¨å¼çš„é˜…è¯»ä½“éªŒã€‚

### 0.2 æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

#### é‡Œç¨‹ç¢‘ä¸€ï¼ˆé˜¶æ®µä¸€ï¼‰ä¼˜å…ˆçº§ P0 åŠŸèƒ½
- **AIåˆ›ä½œæ¨¡å—**ï¼šæƒ…èŠ‚ä»¿å†™ã€æƒ…èŠ‚æ’ç”»åˆ›ä½œã€è§’è‰²3D/2Då½¢è±¡åˆ›ä½œã€æƒ…èŠ‚æ’­å®¢éŸ³é¢‘åˆ›ä½œ
- **AIéŸ³è‰²**ï¼šéŸ³è‰²åˆ†äº«ã€è¯•å¬ã€ç®¡ç†ã€æ‰“åˆ†äº’åŠ¨
- **è´¦å·ç®¡ç†**ï¼šå¤šè§’è‰²åˆ›å»ºã€è§’è‰²èº«ä»½åˆ‡æ¢ç™»å½•ã€æƒé™ç®¡ç†

#### é‡Œç¨‹ç¢‘ä¸€ï¼ˆé˜¶æ®µäºŒï¼‰ä¼˜å…ˆçº§ P0 åŠŸèƒ½
- **AIèŠä¹¦**ï¼šéŸ³è‰²é€‰æ‹©ã€å†å²è®°å½•æŠ˜å ä¼˜åŒ–
- **å¬ä¹¦-AIæ™ºèƒ½ä½“äº¤äº’**ï¼šæˆè¯­å¡«ç©ºã€é˜…è¯»ç†è§£ã€èŠä¹¦äº¤äº’
- **å°é¹…AIäº’åŠ¨**ï¼šç•Œé¢æ•´åˆè°ƒæ•´ã€è€ƒä¸€è€ƒã€ç´ æç´¯ç§¯
- **æ™ºèƒ½ä½“**ï¼šAIæ¨ä¹¦æ™ºèƒ½ä½“ã€AIèŠä¹¦æ™ºèƒ½ä½“ï¼ˆå†…å®¹æ„å»ºã€å¼•å¯¼é—®é¢˜ã€æé—®è¾¹ç•Œï¼‰

#### é‡Œç¨‹ç¢‘äºŒä¼˜å…ˆçº§ P1-P2 åŠŸèƒ½
- **å¾®ä¿¡çŠ¶æ€ä¸åˆ†äº«**ï¼šå£ä»¤è¯é¢˜åŠä¸»é¢˜èƒŒæ™¯ç”Ÿæˆã€å¾®ä¿¡çŠ¶æ€è®¾ç½®ã€æœ‹å‹åœˆåˆ†äº«
- **AIæ¨ä¹¦**ï¼šæ™ºèƒ½æ¨ä¹¦ã€çŒœä½ å–œæ¬¢ã€ç”¨æˆ·å–œå¥½æ”¶é›†ã€æ¨èä¹¦ç±å¡ç‰‡
- **å­¦ä¹ æ¿€åŠ±**ï¼šæ¿€åŠ±ä¸­å¿ƒã€flagæ‰“å¡ã€è™šæ‹Ÿå‹‹ç« ã€ç§¯åˆ†æ˜Ÿæ˜Ÿæœºåˆ¶
- **é˜²æ²‰è¿·ç³»ç»Ÿ**ï¼šAIåŠŸèƒ½ä½¿ç”¨æ¬¡æ•°é™åˆ¶ã€é˜…è¯»æ—¶é•¿é™åˆ¶
- **ç®¡ç†åå°**ï¼šç”¨æˆ·ä½¿ç”¨AIéŸ³è‰²æ•°æ®ç»Ÿè®¡ã€å¬ä¹¦é˜…è¯»ä¹¦ç±ç»Ÿè®¡

### 0.3 æŠ€æœ¯æŒ‘æˆ˜ä¸å…³é”®éœ€æ±‚

1. **AIèƒ½åŠ›é›†æˆ**ï¼šSSEæµå¼è¾“å‡ºã€å¤šæ¨¡æ€å†…å®¹ç”Ÿæˆï¼ˆæ–‡æœ¬/å›¾ç‰‡/éŸ³é¢‘ï¼‰
2. **å®æ—¶äº¤äº’**ï¼šèŠä¹¦å¯¹è¯ã€é—¯å…³ç­”é¢˜ã€éŸ³è‰²åˆ‡æ¢
3. **èµ„æºç®¡ç†**ï¼šCDNå­—ä½“/å›¾ç‰‡ã€ç½‘ç»œå›¾ç‰‡é™åˆ¶ã€å¤§æ–‡ä»¶æ‡’åŠ è½½
4. **æ•°æ®ç»Ÿè®¡**ï¼šç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹ã€é˜…è¯»æ—¶é•¿ç»Ÿè®¡ã€AIä½¿ç”¨æ•°æ®åˆ†æ
5. **æƒé™ç®¡ç†**ï¼šå¤šè§’è‰²è´¦å·ä½“ç³»ã€çˆ¶æ¯-å­å¥³æƒé™æ§åˆ¶
6. **å¾®ä¿¡ç”Ÿæ€é›†æˆ**ï¼šå¾®ä¿¡çŠ¶æ€æ¥å£ï¼ˆéœ€è°ƒç ”ï¼‰ã€åˆ†äº«æœ‹å‹åœˆã€ä¿å­˜å›¾ç‰‡

## 1. é¡¹ç›®åˆå§‹åŒ–

- ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·åˆ›å»ºé¡¹ç›®ï¼Œå¯ç”¨ `npm` æ„å»ºï¼ˆè®¾ç½®ä¸­å¼€å¯ï¼‰

- ç›®å½•å»ºè®®ï¼š

![20260115142716](./images/20260115142716.png)

### 1.1 ä¼é¹…è¯»ä¼´é¡¹ç›®ç›®å½•ç»“æ„

åŸºäºä¸šåŠ¡éœ€æ±‚ï¼Œæ¨èä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```
penguin-reader/
â”œâ”€â”€ pages/                      # é¡µé¢
â”‚   â”œâ”€â”€ index/                  # é¦–é¡µï¼ˆä¹¦ç±åˆ—è¡¨ã€çŒœä½ å–œæ¬¢å…¥å£ï¼‰
â”‚   â”œâ”€â”€ book-detail/            # ä¹¦ç±è¯¦æƒ…é¡µ
â”‚   â”œâ”€â”€ reading/                # å¬ä¹¦é¡µé¢ï¼ˆAIæ™ºèƒ½ä½“äº¤äº’å…¥å£ï¼‰
â”‚   â”œâ”€â”€ ai-chat/                # AIèŠä¹¦é¡µé¢
â”‚   â”œâ”€â”€ ai-recommend/           # AIæ¨ä¹¦é¡µé¢
â”‚   â”œâ”€â”€ ai-create/              # AIåˆ›ä½œé¡µé¢
â”‚   â”‚   â”œâ”€â”€ rewrite/            # æƒ…èŠ‚ä»¿å†™
â”‚   â”‚   â”œâ”€â”€ illustration/       # æƒ…èŠ‚æ’ç”»
â”‚   â”‚   â”œâ”€â”€ character/          # è§’è‰²å½¢è±¡åˆ›ä½œ
â”‚   â”‚   â””â”€â”€ podcast/            # æ’­å®¢éŸ³é¢‘åˆ›ä½œ
â”‚   â”œâ”€â”€ voice-manage/           # éŸ³è‰²ç®¡ç†é¡µ
â”‚   â”œâ”€â”€ incentive-center/       # æ¿€åŠ±ä¸­å¿ƒ
â”‚   â”œâ”€â”€ flag-checkin/           # flagæ‰“å¡
â”‚   â”œâ”€â”€ medal/                  # è™šæ‹Ÿå‹‹ç« 
â”‚   â”œâ”€â”€ profile/                # æˆ‘çš„é¡µé¢ï¼ˆAIåˆ›ä½œå…¥å£ï¼‰
â”‚   â”œâ”€â”€ account-manage/         # è´¦å·ç®¡ç†ï¼ˆå¤šè§’è‰²åˆ‡æ¢ï¼‰
â”‚   â”œâ”€â”€ parental-control/       # é˜²æ²‰è¿·è®¾ç½®
â”‚   â””â”€â”€ wechat-status/          # å¾®ä¿¡çŠ¶æ€ç”Ÿæˆ
â”œâ”€â”€ components/                 # å…¬å…±ç»„ä»¶
â”‚   â”œâ”€â”€ book-card/              # ä¹¦ç±å¡ç‰‡ï¼ˆæ”¯æŒæ¨èè·³è½¬ï¼‰
â”‚   â”œâ”€â”€ voice-player/           # éŸ³è‰²æ’­æ”¾å™¨
â”‚   â”œâ”€â”€ ai-stream-output/       # AIæµå¼è¾“å‡ºç»„ä»¶
â”‚   â”œâ”€â”€ ai-question/            # AIæé—®äº¤äº’ç»„ä»¶
â”‚   â”œâ”€â”€ medal-card/             # å‹‹ç« å¡ç‰‡
â”‚   â”œâ”€â”€ role-selector/          # è§’è‰²é€‰æ‹©å™¨
â”‚   â”œâ”€â”€ share-poster/           # åˆ†äº«æµ·æŠ¥ç”Ÿæˆ
â”‚   â””â”€â”€ skeleton/               # éª¨æ¶å±
â”œâ”€â”€ services/                   # æ¥å£æœåŠ¡
â”‚   â”œâ”€â”€ ai-chat.js              # AIèŠä¹¦æ¥å£ï¼ˆSSEï¼‰
â”‚   â”œâ”€â”€ ai-recommend.js         # AIæ¨ä¹¦æ¥å£
â”‚   â”œâ”€â”€ ai-create.js            # AIåˆ›ä½œæ¥å£
â”‚   â”œâ”€â”€ voice.js                # éŸ³è‰²ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ book.js                 # ä¹¦ç±æ¥å£
â”‚   â”œâ”€â”€ user.js                 # ç”¨æˆ·æ¥å£
â”‚   â”œâ”€â”€ incentive.js            # æ¿€åŠ±ç³»ç»Ÿæ¥å£
â”‚   â””â”€â”€ stats.js                # æ•°æ®ç»Ÿè®¡æ¥å£
â”œâ”€â”€ utils/                      # å·¥å…·ç±»
â”‚   â”œâ”€â”€ request.js              # è¯·æ±‚å°è£…ï¼ˆå«ç­¾åï¼‰
â”‚   â”œâ”€â”€ sse-handler.js          # SSEæµå¼å¤„ç†
â”‚   â”œâ”€â”€ storage.js              # æœ¬åœ°ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ share.js                # åˆ†äº«å·¥å…·
â”‚   â”œâ”€â”€ canvas-poster.js        # Canvasç”Ÿæˆæµ·æŠ¥
â”‚   â”œâ”€â”€ voice-recorder.js       # éŸ³è‰²å½•åˆ¶å·¥å…·
â”‚   â”œâ”€â”€ stats-tracker.js        # æ•°æ®åŸ‹ç‚¹
â”‚   â””â”€â”€ auth.js                 # æƒé™ç®¡ç†
â”œâ”€â”€ store/                      # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ user.js                 # ç”¨æˆ·çŠ¶æ€ï¼ˆå½“å‰è§’è‰²ã€æƒé™ï¼‰
â”‚   â”œâ”€â”€ reading.js              # é˜…è¯»çŠ¶æ€ï¼ˆè¿›åº¦ã€æ—¶é•¿ï¼‰
â”‚   â””â”€â”€ incentive.js            # æ¿€åŠ±çŠ¶æ€ï¼ˆç§¯åˆ†ã€æ˜Ÿæ˜Ÿï¼‰
â”œâ”€â”€ configs/                    # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ env.js                  # ç¯å¢ƒå˜é‡ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ voice-config.js         # éŸ³è‰²é…ç½®
â”‚   â””â”€â”€ cdn-config.js           # CDNèµ„æºé…ç½®
â””â”€â”€ assets/                     # é™æ€èµ„æºï¼ˆä»…å ä½å›¾ï¼‰
    â””â”€â”€ images/
        â””â”€â”€ placeholder.png     # å ä½å›¾ï¼ˆå…¶ä»–èµ°CDNï¼‰
```

## 2. åŸºç¡€é…ç½®

- `app.json`: å£°æ˜ `pages`ã€`window`ï¼ˆå¯¼èˆªæ æ ·å¼ï¼‰ã€`tabBar`  
- `sitemap.json`: é…ç½®æ”¶å½•è§„åˆ™
- ç¯å¢ƒå˜é‡ï¼šæ„å»ºæ—¶æŒ‰ç¯å¢ƒç”Ÿæˆ `configs/env.js`ï¼Œè¿è¡Œæ€ç”¨ `import env from '../../configs/env'`ã€‚æ•æ„Ÿä¿¡æ¯åªä¿ç•™éå¯†é’¥çš„å…¬å¼€é…ç½®

### 2.1 ä¼é¹…è¯»ä¼´ app.json é…ç½®ç¤ºä¾‹

```json
{
  "pages": [
    "pages/index/index",
    "pages/book-detail/book-detail",
    "pages/reading/reading",
    "pages/ai-chat/ai-chat",
    "pages/ai-recommend/ai-recommend",
    "pages/ai-create/ai-create",
    "pages/voice-manage/voice-manage",
    "pages/incentive-center/incentive-center",
    "pages/profile/profile",
    "pages/account-manage/account-manage"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "ä¼é¹…è¯»ä¼´",
    "navigationBarTextStyle": "black"
  },
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#1989FA",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "é¦–é¡µ",
        "iconPath": "assets/images/tab-home.png",
        "selectedIconPath": "assets/images/tab-home-active.png"
      },
      {
        "pagePath": "pages/ai-recommend/ai-recommend",
        "text": "AIæ¨ä¹¦",
        "iconPath": "assets/images/tab-ai.png",
        "selectedIconPath": "assets/images/tab-ai-active.png"
      },
      {
        "pagePath": "pages/incentive-center/incentive-center",
        "text": "æ¿€åŠ±",
        "iconPath": "assets/images/tab-medal.png",
        "selectedIconPath": "assets/images/tab-medal-active.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "æˆ‘çš„",
        "iconPath": "assets/images/tab-profile.png",
        "selectedIconPath": "assets/images/tab-profile-active.png"
      }
    ]
  },
  "permission": {
    "scope.userLocation": {
      "desc": "ç”¨äºç­¾åˆ°åŠŸèƒ½è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯"
    },
    "scope.record": {
      "desc": "ç”¨äºå½•åˆ¶ä¸ªæ€§åŒ–éŸ³è‰²"
    }
  },
  "requiredBackgroundModes": ["audio"],
  "plugins": {
    "chatPlugin": {
      "version": "latest",
      "provider": "wxidxxxxxxxx"
    }
  }
}
```

### 2.2 ç¯å¢ƒå˜é‡é…ç½®ï¼ˆconfigs/env.jsï¼‰

```javascript
// æ„å»ºæ—¶æ ¹æ®ç¯å¢ƒç”Ÿæˆ
export default {
  ENV: 'production', // development | staging | production
  API_BASE_URL: 'https://api.penguinreader.com',
  CDN_BASE_URL: 'https://cdn.penguinreader.com',
  AI_WS_URL: 'wss://ai.penguinreader.com',
  APP_KEY: 'penguin_reader_miniapp',
  // æ³¨æ„ï¼šAPP_SECRET ä»…åç«¯ä½¿ç”¨ï¼Œå‰ç«¯åªä¼  APP_KEY
  VOICE_CDN_URL: 'https://voice-cdn.penguinreader.com',
  IMAGE_CDN_URL: 'https://img-cdn.penguinreader.com',
  MAX_AI_USAGE_FREE: 10, // å…è´¹ç”¨æˆ·æ¯æ—¥AIä½¿ç”¨æ¬¡æ•°ä¸Šé™
  CACHE_TTL: 5 * 60 * 1000, // é¦–é¡µç¼“å­˜5åˆ†é’Ÿ
  READING_INCENTIVE_INTERVAL: 10 * 60 * 1000, // æ¯10åˆ†é’Ÿé˜…è¯»å¥–åŠ±
}
```

## 3. èµ„æºé™åˆ¶ä¸è§„èŒƒ

- èƒŒæ™¯å›¾å¿…é¡»ä½¿ç”¨ç½‘ç»œå›¾ç‰‡ï¼Œä¸èƒ½ä½¿ç”¨æœ¬åœ°å›¾ç‰‡ï¼›ç¡®ä¿ CDN åŸŸååœ¨ä¸‹è½½ç™½åå•å†…
- å­—ä½“å¿…é¡»ä½¿ç”¨ç½‘ç»œå­—ä½“ï¼Œä¸èƒ½æ‰“åŒ…æœ¬åœ°å­—ä½“ï¼›ç”¨ `@font-face` å¼•å…¥ CDNï¼Œéœ€ä¿è¯è·¨åŸŸä¸è¯ä¹¦åˆè§„
- å›¾ç‰‡ä½“ç§¯ä¸åŠ è½½ï¼šé¦–å±ç”¨å‹ç¼© WebP/PNGï¼Œå¤§å›¾æ‡’åŠ è½½ï¼ˆ`image` ç»„ä»¶ `lazy-load`ï¼‰ï¼Œå¿…è¦æ—¶ç”¨å ä½æˆ–éª¨æ¶å±
- é™æ€èµ„æºç¼“å­˜ï¼šCDN è®¾ç½®åˆç†ç¼“å­˜ï¼Œç‰ˆæœ¬æ›´æ–°å¸¦ä¸Š hash/queryï¼Œé˜²æ­¢æ—§ç¼“å­˜

### 3.1 ä¼é¹…è¯»ä¼´èµ„æºç®¡ç†æ–¹æ¡ˆ

#### 3.1.1 ä¹¦ç±å°é¢ä¸æ’ç”»èµ„æº

```javascript
// utils/cdn-helper.js
import env from '../configs/env'

/**
 * è·å–ä¹¦ç±å°é¢ URL
 * @param {string} bookId - ä¹¦ç±ID
 * @param {string} size - å°ºå¯¸ (thumb|medium|large)
 */
export function getBookCoverUrl(bookId, size = 'medium') {
  return `${env.IMAGE_CDN_URL}/books/${bookId}/cover_${size}.webp?v=${env.ASSET_VERSION}`
}

/**
 * è·å–AIç”Ÿæˆçš„æ’ç”» URL
 * @param {string} illustrationId - æ’ç”»ID
 */
export function getIllustrationUrl(illustrationId) {
  return `${env.IMAGE_CDN_URL}/illustrations/${illustrationId}.webp?v=${Date.now()}`
}

/**
 * è·å–åˆ†äº«æµ·æŠ¥èƒŒæ™¯å›¾
 * @param {string} theme - ä¸»é¢˜ç±»å‹
 */
export function getShareBgUrl(theme = 'default') {
  return `${env.IMAGE_CDN_URL}/share-bg/${theme}.webp?v=${env.ASSET_VERSION}`
}

/**
 * è·å–å‹‹ç« å›¾æ ‡
 * @param {string} medalId - å‹‹ç« ID
 */
export function getMedalIconUrl(medalId) {
  return `${env.IMAGE_CDN_URL}/medals/${medalId}.png?v=${env.ASSET_VERSION}`
}
```

#### 3.1.2 éŸ³è‰²èµ„æºç®¡ç†

```javascript
// utils/voice-helper.js
import env from '../configs/env'

/**
 * è·å–éŸ³è‰²è¯•å¬éŸ³é¢‘ URL
 * @param {string} voiceId - éŸ³è‰²ID
 */
export function getVoiceSampleUrl(voiceId) {
  return `${env.VOICE_CDN_URL}/samples/${voiceId}.mp3?v=${env.ASSET_VERSION}`
}

/**
 * è·å–AIç”Ÿæˆçš„æ’­å®¢éŸ³é¢‘ URL
 * @param {string} podcastId - æ’­å®¢ID
 */
export function getPodcastUrl(podcastId) {
  return `${env.VOICE_CDN_URL}/podcasts/${podcastId}.mp3?v=${Date.now()}`
}

/**
 * ä¸Šä¼ éŸ³è‰²å½•éŸ³
 * @param {string} tempFilePath - æœ¬åœ°ä¸´æ—¶æ–‡ä»¶è·¯å¾„
 */
export async function uploadVoiceRecording(tempFilePath) {
  return new Promise((resolve, reject) => {
    wx.uploadFile({
      url: `${env.API_BASE_URL}/voice/upload`,
      filePath: tempFilePath,
      name: 'voice',
      header: {
        'Authorization': wx.getStorageSync('token')
      },
      success: (res) => {
        const data = JSON.parse(res.data)
        if (data.code === 0) {
          resolve(data.data.voiceId)
        } else {
          reject(new Error(data.message))
        }
      },
      fail: reject
    })
  })
}
```

#### 3.1.3 å­—ä½“èµ„æºé…ç½®

```css
/* app.wxss - å…¨å±€å­—ä½“é…ç½® */
@font-face {
  font-family: 'PenguinReaderTitle';
  src: url('https://cdn.penguinreader.com/fonts/title.woff2?v=1.0.0') format('woff2');
  font-weight: bold;
  font-display: swap; /* é¿å…å­—ä½“åŠ è½½é˜»å¡ */
}

@font-face {
  font-family: 'PenguinReaderBody';
  src: url('https://cdn.penguinreader.com/fonts/body.woff2?v=1.0.0') format('woff2');
  font-weight: normal;
  font-display: swap;
}

/* åº”ç”¨å­—ä½“ */
.book-title {
  font-family: 'PenguinReaderTitle', -apple-system, BlinkMacSystemFont, sans-serif;
}

.book-content {
  font-family: 'PenguinReaderBody', -apple-system, BlinkMacSystemFont, sans-serif;
}
```

#### 3.1.4 å›¾ç‰‡æ‡’åŠ è½½ç­–ç•¥

```xml
<!-- ä¹¦ç±åˆ—è¡¨ç»„ä»¶ç¤ºä¾‹ -->
<view class="book-list">
  <view 
    wx:for="{{books}}" 
    wx:key="id" 
    class="book-item"
  >
    <!-- é¦–å±ä¹¦ç±ä¸æ‡’åŠ è½½ï¼Œåç»­æ‡’åŠ è½½ -->
    <image 
      class="book-cover"
      src="{{getBookCoverUrl(item.id, 'medium')}}"
      mode="aspectFill"
      lazy-load="{{index >= 6}}"
      show-menu-by-longpress="{{false}}"
    />
    <view class="book-info">
      <text class="book-title">{{item.title}}</text>
      <text class="book-author">{{item.author}}</text>
    </view>
  </view>
</view>
```

## 4. æ ·å¼ä¸ç»„ä»¶è§„èŒƒ

- ä½¿ç”¨ `rpx` é€‚é…ï¼Œçº¦æŸæœ€å¤§å®½åº¦/é«˜åº¦ï¼Œé¿å…è¶…é•¿æ–‡æ¡ˆæº¢å‡ºï¼ˆ`word-break: break-all`ï¼‰
- ç»„ä»¶åŒ–å¸¸ç”¨æ¨¡å—ï¼šå¯¼èˆªæ ã€åˆ—è¡¨ç©ºæ€ã€åŠ è½½éª¨æ¶ã€é”™è¯¯æç¤º/é‡è¯•
- é¿å…æ»¥ç”¨å…¨å±€æ ·å¼ï¼Œé¡µé¢å†…æ ·å¼ä½œç”¨åŸŸåŒ–ï¼Œå‡å°‘é€‰æ‹©å™¨å±‚çº§ï¼›å›¾æ ‡ä¼˜å…ˆ iconfont/svg sprite

## 5. ç½‘ç»œä¸ç¼“å­˜ç­–ç•¥

- æ— ç½‘ç»œç¼“å­˜ï¼šå…³é”®æ¥å£ä¸ä¾èµ–æœ¬åœ°ç¼“å­˜ï¼Œå¿…è¦æ—¶è¯·æ±‚å¸¦æ—¶é—´æˆ³ï¼›åç«¯è¿”å› `Cache-Control: no-cache`
- åŸŸåä¸ HTTPSï¼šåœ¨å¾®ä¿¡åå°é…ç½® request/upload/download åŸŸåï¼Œå…¨éƒ¨ä½¿ç”¨ HTTPSï¼Œè¯ä¹¦æœ‰æ•ˆä¸”æ— æ··åˆå†…å®¹
- ç½‘ç»œå·®å…œåº•ï¼šåˆç†è¶…æ—¶ä¸é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ï¼›å¼±ç½‘é™çº§åŠ¨æ•ˆ/å›¾ç‰‡è´¨é‡ï¼Œæä¾›ã€Œé‡è¯•ã€æŒ‰é’®ï¼›ç”¨ `wx.getNetworkType` + `onNetworkStatusChange` æç¤ºç”¨æˆ·
- ç¦»çº¿å ä½ï¼šå…è®¸å¯é€‰çš„æœ¬åœ°å ä½æ•°æ®/ç©ºæ€ï¼Œä½†ä¸Šçº¿æ•°æ®å¿…é¡»æ¥è‡ªå®æ—¶æ¥å£

## 6. è¯·æ±‚å°è£…ä¸çŠ¶æ€ç®¡ç†

### 6.1 å°è£… `request`

```mermaid
flowchart TD
  A["baseRequest(options) è°ƒç”¨"] --> B["method/timeout/retries è§£æ„\nupperMethod, timestamp"]
  B --> C{GET ?}
  C -->|æ˜¯| D["æ’åº GET data\nbuildSortedParamString"]
  C -->|å¦| E["JSON.stringify data\nå°è£… param_json"]
  D --> F["encodeURIComponent -> paramJson"]
  E --> G["buildSortedParamString(param_json)\nencodeURIComponent -> paramJson"]
  F --> H["sign(method,timestamp,paramJson)\nHMAC-SHA256(appSecret)"]
  G --> H
  H --> I["ç»„è£… headers\ncontent-type/app/appSecret/method/timestamp/sign\nè¿½åŠ  Authorization(å¯é€‰)"]
  I --> J["wx.request(baseUrl+url, data, headers,\n timeout)"]
  J --> K{statusCode 2xx ?}
  K -->|æ˜¯| L["resolve(data)"]
  K -->|å¦ ä¸” 401/403| M["reject é‰´æƒé”™è¯¯"]
  K -->|å¦ å…¶ä»–| N["reject HTTPé”™è¯¯"]
  J --> O{fail?}
  O -->|ä¸” attempt < retries| P["retry å»¶æ—¶ retryDelay\nattempt+1"]
  O -->|è¶…å‡ºé‡è¯•| Q["reject(err)"]
  P --> J
```

```ts
import crypto from "crypto-js";

// æ›´å¥å£®çš„è¯·æ±‚å°è£…ï¼šç­¾åã€è¶…æ—¶ã€é‡è¯•ã€é‰´æƒé”™è¯¯åˆ†ç±»
export const baseRequest = ({
  url = "",
  method = "GET",
  data = {},
  header = {},
  timeout = 15000,
  retries = 0,
  retryDelay = 500,
  baseUrl = "",
  appKey = "",
  appSecret = "",
  
} = {}) => {
  const upperMethod = method.toUpperCase();
  const timestamp = Math.floor(Date.now() / 1000);

  const buildSortedParamString = (params) => {
    if (!params || typeof params !== "object") return "";
    return Object.keys(params)
      .sort()
      .map((k) => `${k}=${params[k]}`)
      .join("&")
      .replace(/\s+/g, "");
  };

  const hmac = (input, secret) =>
    crypto.HmacSHA256(input, secret).toString(crypto.enc.Hex);

  const sign = (m, ts, paramJson) => {
    const paramPattern = `app_key${appKey}method${m}params${paramJson}timestamp${ts}`;
    const signPattern = appSecret + paramPattern + appSecret;
    return hmac(signPattern, appSecret);
  };

  const paramJson =
    upperMethod === "GET"
      ? encodeURIComponent(buildSortedParamString(data))
      : encodeURIComponent(
          buildSortedParamString({ param_json: JSON.stringify(data || {}) })
        );

  const signature = sign(upperMethod, timestamp, paramJson);

  const headers = {
    "content-type": "application/json",
    ...header,
    app: appKey,
    appSecret,
    method: upperMethod,
    timestamp: timestamp.toString(),
    sign: signature,
  };
  if (header?.Authorization) headers.Authorization = header.Authorization;

  const doRequest = (attempt = 0) =>
    new Promise((resolve, reject) => {
      wx.request({
        url: `${baseUrl}${url}`,
        method: upperMethod,
        data,
        header: headers,
        timeout,
        success: (res) => {
          const { statusCode } = res;
          if (statusCode >= 200 && statusCode < 300) {
            return resolve(res.data ?? res);
          }
          if (statusCode === 401 || statusCode === 403) {
            return reject({ type: "auth", res });
          }
          return reject({ type: "http", res });
        },
        fail: (err) => {
          if (attempt < retries) {
            return setTimeout(
              () => doRequest(attempt + 1).then(resolve).catch(reject),
              retryDelay
            );
          }
          reject(err);
        },
      });
    });

  return doRequest();
};
```

### 6.2 èŠ‚æµä¸å¹¶å‘

åˆ—è¡¨åˆ†é¡µ/æœç´¢æ¥å£åŠ é˜²æŠ–ï¼›é•¿æ—¶é—´ä»»åŠ¡ä½¿ç”¨è½®è¯¢æˆ– `backgroundFetch`

### 6.3 é¡µé¢æ•°æ®æµç¼“å­˜

`onLoad` æ‹‰é¦–å±ï¼Œ`onPullDownRefresh` è§¦å‘åˆ·æ–°ï¼Œåˆ†é¡µå¤„ç† `no more` çŠ¶æ€ï¼›ä¸‹æ‹‰/ä¸Šæ‹‰ç»“æŸåè®°å¾— `stopPullDownRefresh`

**é¦–é¡µè¯·æ±‚ç¼“å­˜çš„ä½œç”¨**

- é¦–é¡µè¯·æ±‚ç¼“å­˜æ˜¯ä¸ºäº†æé«˜é¦–é¡µçš„åŠ è½½é€Ÿåº¦ï¼Œé¿å…ç”¨æˆ·åœ¨é¦–é¡µç­‰å¾…è¿‡é•¿æ—¶é—´ï¼Œä»è€Œæé«˜ç”¨æˆ·ä½“éªŒã€‚
- é¦–é¡µè¯·æ±‚ç¼“å­˜ï¼Œé˜²æ­¢æ–­ç½‘åŠå¼±ç½‘æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°å†…å®¹ã€‚

**é¦–é¡µè¯·æ±‚ç¼“å­˜çš„å®ç°**

```mermaid
flowchart TD
  A[è¿›å…¥é¦–é¡µ onLoad] --> B{æœ¬åœ°æœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸ?}
  B -- å¦ --> C[æ˜¾ç¤ºéª¨æ¶å±/ç©ºæ€å ä½]
  B -- æ˜¯ --> D[è¯»å–ç¼“å­˜å¹¶æ¸²æŸ“å ä½æ•°æ®]
  D --> E[å¹¶è¡Œå‘èµ·æ¥å£è¯·æ±‚]
  C --> E
  E --> F{è¯·æ±‚æˆåŠŸ?}
  F -- å¦ --> G[æç¤ºå¼±ç½‘/é‡è¯•æŒ‰é’®]
  F -- æ˜¯ --> H[æ›´æ–°é¡µé¢æ•°æ®]
  H --> I[å†™å…¥ç¼“å­˜ï¼šæ•°æ® + æ—¶é—´æˆ³]
  G --> J[ä¸‹æ‹‰åˆ·æ–°/æŒ‰é’®é‡è¯•]
  J --> E
```

ç¤ºä¾‹ï¼šåŸºäºå‰é¢ `request` å°è£…çš„è½»é‡ç¼“å­˜æ–¹æ³•ï¼Œæ”¯æŒ TTLã€å¼ºåˆ¶åˆ·æ–°ã€æ–­ç½‘å›é€€ï¼š

```js
// utils/baseRequest.js
import { baseRequest } from "./baseRequest";

/**
 * æ‹‰å–å¹¶ç¼“å­˜æ¥å£æ•°æ®
 * @param {Object} opts
 * @param {string} opts.key ç¼“å­˜é”®ï¼ˆå»ºè®®åŒ…å«æ¥å£è·¯å¾„ä¸æŸ¥è¯¢å‚æ•°ï¼‰
 * @param {string} opts.url æ¥å£è·¯å¾„
 * @param {Object} [opts.data] è¯·æ±‚å‚æ•°
 * @param {number} [opts.ttl=5 * 60 * 1000] ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰
 * @param {boolean} [opts.force=false] æ˜¯å¦è·³è¿‡ç¼“å­˜ç›´æ¥è¯·æ±‚
 */
export async function requestWithCache({
  key,
  url,
  data,
  ttl = 5 * 60 * 1000,
  force = false,
}) {
  const now = Date.now();
  const cached = wx.getStorageSync(key);

  const isValid =
    cached &&
    cached.data !== undefined &&
    typeof cached.ts === "number" &&
    now - cached.ts < ttl;

  // å‘½ä¸­ç¼“å­˜ä¸”éå¼ºåˆ¶åˆ·æ–°
  if (!force && isValid) {
    // ç«‹å³è¿”å›ç¼“å­˜ï¼Œå¹¶åœ¨åå°é™é»˜åˆ·æ–°ï¼ˆå‡å°‘é¦–å±ç­‰å¾…ï¼‰
    refreshInBackground();
    return { data: cached.data, from: "cache" };
  }

  // ç›´æ¥è¯·æ±‚
  return fetchAndStore();

  async function fetchAndStore() {
    try {
      const res = await baseRequest({ url, data });
      wx.setStorageSync(key, { data: res, ts: now });
      return { data: res, from: "network" };
    } catch (err) {
      // æ–­ç½‘æˆ–å¤±è´¥æ—¶å°è¯•å›é€€ç¼“å­˜
      if (cached) {
        return { data: cached.data, from: "stale-cache", error: err };
      }
      throw err;
    }
  }

  function refreshInBackground() {
    baseRequest({ url, data })
      .then((res) => wx.setStorageSync(key, { data: res, ts: Date.now() }))
      .catch(() => {});
  }
}
```

## 7. å®‰å…¨ç­–ç•¥

- å…¨ç¨‹ HTTPSï¼Œä¸Šä¼ /ä¸‹è½½åŒåŸŸï¼›æ¥å£ç­¾å/æ—¶é—´æˆ³åœ¨åç«¯å®Œæˆ
- token ä»…çŸ­æœŸå­˜å‚¨ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰ï¼Œé¿å…å†™æ­»å¯†é’¥ï¼›æ•æ„Ÿæ“ä½œäºŒæ¬¡ç¡®è®¤
- å…³é—­è°ƒè¯•å¼€å…³ä¸å¤šä½™ `console`ï¼Œåœ¨å°ç¨‹åºåå°å¼€å¯å®‰å…¨ä¸åˆè§„æ£€æŸ¥ï¼Œå®¡æŸ¥ç¬¬ä¸‰æ–¹ SDK ä»…ä¿ç•™å¿…è¦æƒé™

## 8. æ€§èƒ½ä¸åŠ¨æ•ˆ

- æ€§èƒ½ï¼šé¦–å±æ¥å£åˆå¹¶/å¹¶è¡Œï¼Œå‡å°‘ setData é¢‘æ¬¡ä¸å¯¹è±¡æ·±åº¦ï¼Œåˆ—è¡¨ä½¿ç”¨åˆ†æ‰¹æ¸²æŸ“ï¼›å¿…è¦æ—¶åˆ†åŒ…ä¸ç‹¬ç«‹åˆ†åŒ…
- åŠ¨æ•ˆï¼šä¼˜å…ˆ CSS è¿‡æ¸¡/åŠ¨ç”»æˆ– `wx.createAnimation`ï¼Œé¿å…é«˜é¢‘ JS é©±åŠ¨ï¼›ä½ç«¯æœºé™çº§ï¼ˆç¼©çŸ­æ—¶é•¿ã€å‡å°‘é˜´å½±/æ¨¡ç³Šï¼‰
- å›¾ç‰‡ä¸è§†é¢‘ï¼šå¼€å¯ `lazy-load`ï¼Œè§†é¢‘å°é¢ä½¿ç”¨å‹ç¼©å›¾ï¼›é¿å…åœ¨å¼±ç½‘è‡ªåŠ¨æ’­æ”¾è§†é¢‘

## 9. å…¶ä»–æœåŠ¡

### 9.1 åœ°å›¾æœåŠ¡

- ä½¿ç”¨è…¾è®¯åœ°å›¾ APIï¼Œæä¾›ä½ç½®æœåŠ¡ã€è·¯çº¿è§„åˆ’ã€POI æœç´¢ç­‰åŠŸèƒ½
- åœ°å›¾ç»„ä»¶ï¼š`map` ç»„ä»¶ï¼Œæ”¯æŒåœ°å›¾ç±»å‹ã€ç¼©æ”¾çº§åˆ«ã€æ ‡è®°ç‚¹ã€è·¯çº¿æ˜¾ç¤ºç­‰
- åœ°å›¾äº‹ä»¶ï¼š`bindmarkertap`ã€`bindcallouttap`ã€`bindregionchange`ã€`bindmarkertap` ç­‰
- åœ°å›¾äº¤äº’ï¼š`wx.getLocation`ã€`wx.openLocation`ã€`wx.getRoute` ç­‰
- åœ°å›¾æ ·å¼ï¼š`wx.getMapStyle`ã€`wx.setMapStyle` ç­‰
- åœ°å›¾æƒé™ï¼š`wx.getLocation`ã€`wx.openLocation`ã€`wx.getRoute` ç­‰

### 9.2 åˆ†äº«

- ä½¿ç”¨å¾®ä¿¡åˆ†äº« APIï¼Œæä¾›åˆ†äº«åŠŸèƒ½
- åˆ†äº«ç»„ä»¶ï¼š`share` ç»„ä»¶ï¼Œæ”¯æŒåˆ†äº«ç±»å‹ã€åˆ†äº«å†…å®¹ã€åˆ†äº«é“¾æ¥ç­‰
- åˆ†äº«äº‹ä»¶ï¼š`bindshare`ã€`bindshareappmessage`ã€`bindsharetimeline` ç­‰
- åˆ†äº«äº¤äº’ï¼š`wx.shareAppMessage`ã€`wx.shareTimeline` ç­‰
- åˆ†äº«æ ·å¼ï¼š`wx.getShareInfo`ã€`wx.getShareTicket` ç­‰

### 9.3 ç­¾åˆ°

- ä½¿ç”¨å¾®ä¿¡ wx.getLocation è·å–ç”¨æˆ·å½“å‰ä½ç½®ï¼Œæä¾›ç­¾åˆ°åŠŸèƒ½
- ç»“åˆåœ°å›¾æœåŠ¡ï¼Œæä¾›ç­¾åˆ°ä½ç½®çš„å±•ç¤º

### 9.4 SSE æµå¼ä¼ è¾“ï¼ˆAI èŠä¹¦/æ¨ä¹¦æ ¸å¿ƒæŠ€æœ¯ï¼‰

```mermaid
flowchart TD
  A[ç”¨æˆ·å‘èµ·AIå¯¹è¯è¯·æ±‚] --> B[åˆ›å»º wx.request ä»»åŠ¡]
  B --> C[è®¾ç½® enableChunkedï¼štrue]
  C --> D[ç›‘å¬ onChunkReceived äº‹ä»¶]
  D --> E[è§£æ SSE æ•°æ®æµ]
  E --> F{æ•°æ®ç±»å‹åˆ¤æ–­}
  F -->|æ–‡æœ¬å†…å®¹| G[é€å­—è¿½åŠ åˆ°é¡µé¢]
  F -->|å¼•å¯¼é—®é¢˜| H[æ¸²æŸ“å¼•å¯¼æŒ‰é’®]
  F -->|æ¨èä¹¦ç±| I[æ¸²æŸ“ä¹¦ç±å¡ç‰‡]
  F -->|é”™è¯¯ä¿¡æ¯| J[æ˜¾ç¤ºé”™è¯¯æç¤º]
  G --> K{æµå¼ç»“æŸ?}
  H --> K
  I --> K
  K -->|å¦| D
  K -->|æ˜¯| L[è°ƒç”¨ success å›è°ƒ]
  L --> M[è®°å½•å¯¹è¯å†å²]
  M --> N[ç»“æŸ]
```

[å¾®ä¿¡å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.html)

#### 9.4.1 ä¼é¹…è¯»ä¼´ SSE å°è£…å®ç°

```javascript
// utils/sse-handler.js
import { baseRequest } from './request'

/**
 * SSE æµå¼è¯·æ±‚å°è£…ï¼ˆç”¨äº AI èŠä¹¦ã€AI æ¨ä¹¦ï¼‰
 * @param {Object} options
 * @param {string} options.url - æ¥å£è·¯å¾„
 * @param {Object} options.data - è¯·æ±‚å‚æ•°
 * @param {Function} options.onMessage - æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶çš„å›è°ƒ
 * @param {Function} options.onEnd - æµå¼ç»“æŸæ—¶çš„å›è°ƒ
 * @param {Function} options.onError - é”™è¯¯å›è°ƒ
 */
export function sseRequest({
  url,
  data = {},
  onMessage,
  onEnd,
  onError
}) {
  let buffer = '' // ç¼“å­˜æœªå®Œæˆçš„æ•°æ®å—
  let isEnded = false

  const requestTask = wx.request({
    url: `${getApp().globalData.baseUrl}${url}`,
    method: 'POST',
    data,
    header: {
      'Content-Type': 'application/json',
      'Authorization': wx.getStorageSync('token')
    },
    enableChunked: true, // å…³é”®ï¼šå¼€å¯åˆ†å—ä¼ è¾“
    timeout: 60000, // AI å¯¹è¯å¯èƒ½è¾ƒé•¿ï¼Œè®¾ç½® 60s è¶…æ—¶
    success: (res) => {
      if (!isEnded && res.statusCode === 200) {
        onEnd && onEnd()
      }
    },
    fail: (err) => {
      console.error('SSE request failed:', err)
      onError && onError(err)
    }
  })

  // ç›‘å¬åˆ†å—æ•°æ®
  requestTask.onChunkReceived((chunk) => {
    try {
      // å°† ArrayBuffer è½¬æ¢ä¸ºå­—ç¬¦ä¸²
      const decoder = new TextDecoder('utf-8')
      const text = decoder.decode(new Uint8Array(chunk.data))
      buffer += text

      // æŒ‰è¡Œåˆ†å‰² SSE æ•°æ®
      const lines = buffer.split('\n')
      buffer = lines.pop() || '' // ä¿ç•™æœ€åä¸€ä¸ªæœªå®Œæˆçš„è¡Œ

      lines.forEach(line => {
        if (line.startsWith('data: ')) {
          const dataStr = line.slice(6).trim()
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯ç»“æŸæ ‡è®°
          if (dataStr === '[DONE]') {
            isEnded = true
            onEnd && onEnd()
            return
          }

          try {
            const data = JSON.parse(dataStr)
            onMessage && onMessage(data)
          } catch (e) {
            console.warn('Failed to parse SSE data:', dataStr)
          }
        }
      })
    } catch (err) {
      console.error('SSE chunk processing error:', err)
      onError && onError(err)
    }
  })

  // è¿”å›è¯·æ±‚ä»»åŠ¡ï¼Œæ”¯æŒæ‰‹åŠ¨ä¸­æ–­
  return {
    abort: () => requestTask.abort()
  }
}
```

#### 9.4.2 AI èŠä¹¦åŠŸèƒ½å®ç°ç¤ºä¾‹

```javascript
// services/ai-chat.js
import { sseRequest } from '../utils/sse-handler'

/**
 * AI èŠä¹¦å¯¹è¯
 * @param {Object} params
 * @param {string} params.bookId - ä¹¦ç±ID
 * @param {string} params.question - ç”¨æˆ·æé—®
 * @param {string} params.voiceId - éŸ³è‰²IDï¼ˆå¯é€‰ï¼‰
 * @param {Array} params.history - å¯¹è¯å†å²
 */
export function chatWithBook({
  bookId,
  question,
  voiceId = null,
  history = [],
  onMessage,
  onEnd,
  onError
}) {
  return sseRequest({
    url: '/ai/chat',
    data: {
      book_id: bookId,
      question,
      voice_id: voiceId,
      history: history.slice(-10) // åªä¿ç•™æœ€è¿‘10è½®å¯¹è¯
    },
    onMessage: (data) => {
      // data æ ¼å¼ç¤ºä¾‹ï¼š
      // { type: 'text', content: 'æ ¹æ®ä¹¦ä¸­çš„æè¿°...' }
      // { type: 'question', content: 'ä½ è§‰å¾—ä¸»è§’ä¸ºä»€ä¹ˆ...', options: ['å› ä¸º...', 'ç”±äº...'] }
      // { type: 'book_card', book_id: '123', title: 'æ¨èä¹¦ç±', reason: 'å¦‚æœä½ å–œæ¬¢è¿™æœ¬ï¼Œä¹Ÿä¼šå–œæ¬¢...' }
      onMessage && onMessage(data)
    },
    onEnd: () => {
      console.log('AI èŠä¹¦å¯¹è¯ç»“æŸ')
      onEnd && onEnd()
    },
    onError: (err) => {
      console.error('AI èŠä¹¦å¤±è´¥:', err)
      wx.showToast({
        title: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
      onError && onError(err)
    }
  })
}
```

#### 9.4.3 AI èŠä¹¦é¡µé¢å®ç°

```javascript
// pages/ai-chat/ai-chat.js
import { chatWithBook } from '../../services/ai-chat'
import { getVoiceList } from '../../services/voice'

Page({
  data: {
    bookId: '',
    bookInfo: {},
    messages: [], // å¯¹è¯æ¶ˆæ¯åˆ—è¡¨
    userInput: '',
    isLoading: false,
    currentVoiceId: null, // å½“å‰é€‰æ‹©çš„éŸ³è‰²
    voiceList: [], // å¯ç”¨éŸ³è‰²åˆ—è¡¨
    isVoiceEnabled: false, // æ˜¯å¦å¼€å¯è¯­éŸ³è¾“å‡º
    guideQuestions: [], // AI å¼•å¯¼é—®é¢˜
  },

  onLoad(options) {
    this.setData({
      bookId: options.bookId
    })
    this.loadBookInfo()
    this.loadVoiceList()
  },

  // åŠ è½½ä¹¦ç±ä¿¡æ¯
  async loadBookInfo() {
    // ... åŠ è½½ä¹¦ç±ä¿¡æ¯é€»è¾‘
  },

  // åŠ è½½éŸ³è‰²åˆ—è¡¨
  async loadVoiceList() {
    try {
      const voices = await getVoiceList()
      this.setData({ voiceList: voices })
    } catch (err) {
      console.error('åŠ è½½éŸ³è‰²å¤±è´¥:', err)
    }
  },

  // åˆ‡æ¢éŸ³è‰²
  onVoiceChange(e) {
    const voiceId = e.detail.value
    this.setData({ currentVoiceId: voiceId })
    wx.showToast({
      title: 'éŸ³è‰²å·²åˆ‡æ¢',
      icon: 'success'
    })
  },

  // åˆ‡æ¢è¯­éŸ³è¾“å‡º
  onToggleVoice(e) {
    this.setData({ isVoiceEnabled: e.detail.value })
  },

  // å‘é€æ¶ˆæ¯
  async sendMessage() {
    const { userInput, bookId, currentVoiceId, messages } = this.data
    
    if (!userInput.trim()) {
      wx.showToast({ title: 'è¯·è¾“å…¥é—®é¢˜', icon: 'none' })
      return
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMsg = {
      role: 'user',
      content: userInput,
      timestamp: Date.now()
    }
    this.setData({
      messages: [...messages, userMsg],
      userInput: '',
      isLoading: true,
      guideQuestions: []
    })

    // AI å›å¤æ¶ˆæ¯ï¼ˆå ä½ï¼‰
    const aiMsg = {
      role: 'assistant',
      content: '',
      timestamp: Date.now(),
      type: 'text'
    }
    this.setData({
      messages: [...this.data.messages, aiMsg]
    })

    // å‘èµ· SSE è¯·æ±‚
    const chatTask = chatWithBook({
      bookId,
      question: userInput,
      voiceId: this.data.isVoiceEnabled ? currentVoiceId : null,
      history: messages,
      onMessage: (data) => {
        this.handleAIMessage(data)
      },
      onEnd: () => {
        this.setData({ isLoading: false })
        // è®°å½•å¯¹è¯å†å²åˆ°æœ¬åœ°
        this.saveChatHistory()
      },
      onError: (err) => {
        this.setData({ isLoading: false })
        // åˆ é™¤å¤±è´¥çš„ AI æ¶ˆæ¯å ä½
        const newMessages = this.data.messages.slice(0, -1)
        this.setData({ messages: newMessages })
      }
    })

    // ä¿å­˜ä»»åŠ¡å¼•ç”¨ï¼Œæ”¯æŒä¸­æ–­
    this.currentChatTask = chatTask
  },

  // å¤„ç† AI æ¶ˆæ¯
  handleAIMessage(data) {
    const { messages } = this.data
    const lastMsg = messages[messages.length - 1]

    if (data.type === 'text') {
      // è¿½åŠ æ–‡æœ¬å†…å®¹ï¼ˆé€å­—æ˜¾ç¤ºæ•ˆæœï¼‰
      lastMsg.content += data.content
      this.setData({
        messages: [...messages.slice(0, -1), lastMsg]
      })
      // æ»šåŠ¨åˆ°åº•éƒ¨
      this.scrollToBottom()
    } else if (data.type === 'question') {
      // AI å¼•å¯¼é—®é¢˜
      this.setData({
        guideQuestions: data.options || []
      })
    } else if (data.type === 'book_card') {
      // æ¨èä¹¦ç±å¡ç‰‡
      lastMsg.bookCard = {
        bookId: data.book_id,
        title: data.title,
        reason: data.reason
      }
      this.setData({
        messages: [...messages.slice(0, -1), lastMsg]
      })
    }
  },

  // ç‚¹å‡»å¼•å¯¼é—®é¢˜
  onGuideQuestionTap(e) {
    const question = e.currentTarget.dataset.question
    this.setData({ userInput: question })
    this.sendMessage()
  },

  // è·³è½¬åˆ°æ¨èçš„ä¹¦ç±
  onBookCardTap(e) {
    const bookId = e.currentTarget.dataset.bookId
    wx.navigateTo({
      url: `/pages/book-detail/book-detail?id=${bookId}`
    })
  },

  // ä¿å­˜å¯¹è¯å†å²
  saveChatHistory() {
    const { bookId, messages } = this.data
    wx.setStorage({
      key: `chat_history_${bookId}`,
      data: messages
    })
  },

  // æ»šåŠ¨åˆ°åº•éƒ¨
  scrollToBottom() {
    this.setData({
      scrollIntoView: `msg-${this.data.messages.length - 1}`
    })
  },

  // é¡µé¢å¸è½½æ—¶ä¸­æ–­è¯·æ±‚
  onUnload() {
    if (this.currentChatTask) {
      this.currentChatTask.abort()
    }
  }
})
```

#### 9.4.4 AI æ¨ä¹¦åŠŸèƒ½å®ç°

```javascript
// services/ai-recommend.js
import { sseRequest } from '../utils/sse-handler'

/**
 * AI æ™ºèƒ½æ¨ä¹¦
 * @param {Object} params
 * @param {string} params.userQuery - ç”¨æˆ·æè¿°ï¼ˆå¦‚"æƒ³çœ‹å†’é™©ç±»çš„ä¹¦"ï¼‰
 * @param {Object} params.userProfile - ç”¨æˆ·ç”»åƒï¼ˆå¹´çº§ã€å…´è¶£æ ‡ç­¾ç­‰ï¼‰
 */
export function aiRecommendBooks({
  userQuery,
  userProfile = {},
  onMessage,
  onEnd,
  onError
}) {
  return sseRequest({
    url: '/ai/recommend',
    data: {
      query: userQuery,
      profile: userProfile
    },
    onMessage: (data) => {
      // data æ ¼å¼ç¤ºä¾‹ï¼š
      // { type: 'thinking', content: 'æ­£åœ¨åˆ†ææ‚¨çš„é˜…è¯»åå¥½...' }
      // { type: 'category', content: 'æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæ¨èä»¥ä¸‹åˆ†ç±»ï¼šå†’é™©ã€ç§‘å¹»' }
      // { type: 'book_list', books: [{ id, title, author, reason }] }
      onMessage && onMessage(data)
    },
    onEnd,
    onError
  })
}
```

### 9.5 AI å¯¹è¯

- ä½¿ç”¨ [WeChat MiniProgram AI Chat](https://tdesign.tencent.com/miniprogram-chat/getting-started)

---

## 10. ä¼é¹…è¯»ä¼´æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½æŠ€æœ¯å®ç°

### 10.1 AI éŸ³è‰²ç®¡ç†

#### 10.1.1 éŸ³è‰²å½•åˆ¶ä¸ç”Ÿæˆæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡»å½•åˆ¶éŸ³è‰²] --> B{æ£€æŸ¥å½•éŸ³æƒé™}
    B -->|å·²æˆæƒ| C[å¼€å§‹å½•éŸ³<br/>60ç§’å€’è®¡æ—¶]
    B -->|æœªæˆæƒ| D[å¼¹çª—ç”³è¯·æƒé™]
    D -->|ç”¨æˆ·åŒæ„| C
    D -->|ç”¨æˆ·æ‹’ç»| E[å¼•å¯¼å»è®¾ç½®é¡µé¢]
    
    C --> F[ç”¨æˆ·ç‚¹å‡»åœæ­¢<br/>æˆ–è¾¾åˆ°60ç§’]
    F --> G[è·å–ä¸´æ—¶éŸ³é¢‘æ–‡ä»¶]
    G --> H[æ˜¾ç¤ºåŠ è½½æç¤º<br/>ç”ŸæˆéŸ³è‰²ä¸­...]
    H --> I[ä¸Šä¼ éŸ³é¢‘åˆ°æœåŠ¡å™¨]
    
    I -->|æˆåŠŸ| J[åç«¯ AI å¤„ç†<br/>ç”Ÿæˆä¸ªæ€§åŒ–éŸ³è‰²]
    I -->|å¤±è´¥| K[é‡è¯•æˆ–æç¤ºé”™è¯¯]
    
    J --> L[è¿”å›éŸ³è‰² ID]
    L --> M[è·³è½¬åˆ°è¯•å¬é¡µé¢]
    M --> N[æ’­æ”¾ç³»ç»Ÿé¢„è®¾æ–‡æœ¬<br/>å±•ç¤ºéŸ³è‰²æ•ˆæœ]
    N --> O{ç”¨æˆ·æ»¡æ„?}
    
    O -->|æ˜¯| P[ä¿å­˜éŸ³è‰²åˆ°æˆ‘çš„éŸ³è‰²åˆ—è¡¨]
    O -->|å¦| Q[åˆ é™¤å¹¶é‡æ–°å½•åˆ¶]
    
    P --> R[å¯åˆ†äº«/åº”ç”¨åˆ°å¬ä¹¦]
```

#### 10.1.2 éŸ³è‰²åˆ†äº«ä¸æ¥æ”¶æµç¨‹

```mermaid
flowchart TD
    A[æˆ‘çš„éŸ³è‰²åˆ—è¡¨] --> B[é€‰æ‹©éŸ³è‰²ç‚¹å‡»åˆ†äº«]
    B --> C[ç”Ÿæˆåˆ†äº«å¡ç‰‡<br/>éŸ³è‰²åç§°+è¯•å¬æŒ‰é’®]
    C --> D[é€‰æ‹©åˆ†äº«æ¸ é“]
    D --> E[å¾®ä¿¡å¥½å‹]
    D --> F[å¾®ä¿¡ç¾¤]
    
    E --> G[å¥½å‹ç‚¹å‡»å°ç¨‹åºå¡ç‰‡]
    F --> G
    
    G --> H[è¿›å…¥éŸ³è‰²æ¥æ”¶é¡µé¢<br/>æ˜¾ç¤ºåˆ†äº«äººä¿¡æ¯]
    H --> I[æ’­æ”¾è¯•å¬éŸ³é¢‘<br/>æŸ¥çœ‹éŸ³è‰²è¯¦æƒ…]
    I --> J{æ˜¯å¦æ¥å—éŸ³è‰²?}
    
    J -->|æ¥å—| K[ä¿å­˜åˆ°<br/>æ¥å—åˆ°çš„ä»–äººéŸ³è‰²åˆ—è¡¨]
    J -->|æ‹’ç»| L[å…³é—­é¡µé¢]
    
    K --> M[å¼¹å‡ºæ‰“åˆ†äº’åŠ¨<br/>éŸ³è‰²é€‚é…åº¦è¯„ä»·]
    M --> N[é€‰æ‹©è¯„åˆ†<br/>éå¸¸é€‚åˆ/æ¯”è¾ƒé€‚åˆ/ä¸€èˆ¬/ä¸å¤ªé€‚åˆ]
    N --> O[æäº¤è¯„åˆ†åé¦ˆ]
    O --> P[æ¨é€é€šçŸ¥ç»™åˆ†äº«äºº<br/>æ˜¾ç¤ºæ¥æ”¶è€…çš„è¯„ä»·]
    
    K --> Q[è¯¥éŸ³è‰²å¯ç”¨äºå¬ä¹¦<br/>ä¸å¯å†æ¬¡åˆ†äº«]
```

#### 10.1.3 éŸ³è‰²ç®¡ç†é¡µé¢ç»“æ„

```mermaid
flowchart LR
    A[éŸ³è‰²ç®¡ç†] --> B[æˆ‘çš„éŸ³è‰²]
    A --> C[æ¥æ”¶åˆ°çš„éŸ³è‰²]
    
    B --> B1[éŸ³è‰²1<br/>å¯è¯•å¬/åˆ†äº«/åˆ é™¤/æŸ¥çœ‹è¯¦æƒ…]
    B --> B2[éŸ³è‰²2<br/>å¯è¯•å¬/åˆ†äº«/åˆ é™¤/æŸ¥çœ‹è¯¦æƒ…]
    B --> B3[+ å½•åˆ¶æ–°éŸ³è‰²]
    
    C --> C1[å¥½å‹Açš„éŸ³è‰²<br/>å¯è¯•å¬/åˆ é™¤<br/>ä¸å¯åˆ†äº«/ä¸å¯æŸ¥çœ‹è¯¦æƒ…]
    C --> C2[å¥½å‹Bçš„éŸ³è‰²<br/>å¯è¯•å¬/åˆ é™¤<br/>ä¸å¯åˆ†äº«/ä¸å¯æŸ¥çœ‹è¯¦æƒ…]
    
    B1 --> D[åº”ç”¨åœºæ™¯]
    B2 --> D
    C1 --> D
    C2 --> D
    
    D --> D1[å¬ä¹¦é¡µé¢<br/>é€‰æ‹©éŸ³è‰²æ’­æ”¾]
    D --> D2[AIèŠä¹¦<br/>è¯­éŸ³è¾“å‡º]
```

#### 10.1.4 éŸ³è‰²åœ¨å¬ä¹¦åœºæ™¯çš„åº”ç”¨æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥å¬ä¹¦é¡µé¢] --> B[ç‚¹å‡»éŸ³è‰²åˆ‡æ¢æŒ‰é’®]
    B --> C[å±•å¼€éŸ³è‰²é€‰æ‹©é¢æ¿]
    C --> D[æ˜¾ç¤ºå¯ç”¨éŸ³è‰²åˆ—è¡¨]
    
    D --> D1[ç³»ç»Ÿé»˜è®¤éŸ³è‰²]
    D --> D2[æˆ‘çš„éŸ³è‰² x N]
    D --> D3[æ¥æ”¶åˆ°çš„éŸ³è‰² x M]
    
    D1 --> E{ç”¨æˆ·é€‰æ‹©éŸ³è‰²}
    D2 --> E
    D3 --> E
    
    E --> F[ç‚¹å‡»è¯•å¬æŒ‰é’®<br/>æ’­æ”¾ç¤ºä¾‹æ–‡æœ¬]
    F --> G{æ»¡æ„?}
    
    G -->|å¦| C
    G -->|æ˜¯| H[åº”ç”¨è¯¥éŸ³è‰²]
    
    H --> I[åœæ­¢å½“å‰æ’­æ”¾]
    I --> J[ä½¿ç”¨æ–°éŸ³è‰²<br/>ç»§ç»­æ’­æ”¾ä¹¦ç±å†…å®¹]
    J --> K[ä¿å­˜ç”¨æˆ·åå¥½<br/>ä¸‹æ¬¡è‡ªåŠ¨ä½¿ç”¨è¯¥éŸ³è‰²]
```

### 10.2 å­¦ä¹ æ¿€åŠ±ç³»ç»Ÿ

#### 10.2.1 æ¿€åŠ±ç³»ç»Ÿæ•´ä½“æ¶æ„

```mermaid
flowchart TD
    A[å­¦ä¹ æ¿€åŠ±ç³»ç»Ÿ] --> B[è·å–å¥–åŠ±]
    A --> C[æ¶ˆè´¹å¥–åŠ±]
    A --> D[å±•ç¤ºæˆå°±]
    
    B --> B1[é˜…è¯»æ¿€åŠ±<br/>æ¯10åˆ†é’Ÿ<br/>+10ç§¯åˆ† +1æ˜Ÿæ˜Ÿ]
    B --> B2[é—¯å…³ç­”é¢˜<br/>ç­”å¯¹ä¸€é¢˜<br/>+5ç§¯åˆ† +1æ˜Ÿæ˜Ÿ]
    B --> B3[æˆè¯­å¡«ç©º<br/>å¡«å¯¹ä¸€ä¸ª<br/>+3ç§¯åˆ† +1æ˜Ÿæ˜Ÿ]
    B --> B4[AIèŠä¹¦<br/>æ¯æ¬¡å¯¹è¯<br/>+5ç§¯åˆ† +1æ˜Ÿæ˜Ÿ]
    
    B1 --> E[ç§¯åˆ†æ± ]
    B2 --> E
    B3 --> E
    B4 --> E
    
    B1 --> F[æ˜Ÿæ˜Ÿæ± ]
    B2 --> F
    B3 --> F
    B4 --> F
    
    C --> C1[å…‘æ¢è™šæ‹Ÿå‹‹ç« ]
    C --> C2[å…‘æ¢ç‰¹æƒåŠŸèƒ½<br/>æš‚æœªå¼€æ”¾]
    
    F --> C1
    
    D --> D1[æ¿€åŠ±ä¸­å¿ƒçœ‹æ¿<br/>æ€»ç§¯åˆ†/æ€»æ˜Ÿæ˜Ÿ]
    D --> D2[å‹‹ç« å¢™]
    D --> D3[æ¯å‘¨ Flag è¿›åº¦]
    
    C1 --> D2
```

#### 10.2.2 é˜…è¯»æ¿€åŠ±æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥å¬ä¹¦é¡µé¢] --> B[å¼€å§‹è®¡æ—¶]
    B --> C[æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡]
    
    C --> D{ç´¯è®¡æ»¡10åˆ†é’Ÿ?}
    D -->|å¦| C
    D -->|æ˜¯| E{ä»Šæ—¥å¥–åŠ±æ¬¡æ•°<6æ¬¡?}
    
    E -->|å¦| F[ä¸å†å‘æ”¾å¥–åŠ±<br/>ç»§ç»­è®¡æ—¶]
    E -->|æ˜¯| G[è§¦å‘å¥–åŠ±å‘æ”¾]
    
    F --> C
    
    G --> H[è°ƒç”¨åç«¯æ¥å£<br/>è®°å½•é˜…è¯»æ—¶é•¿]
    H --> I[å‘æ”¾ +10ç§¯åˆ† +1æ˜Ÿæ˜Ÿ]
    I --> J[å¼¹çª—æç¤º<br/>æ˜¾ç¤ºè·å¾—å¥–åŠ±]
    
    J --> K{æ˜¯å¦è§£é”æ–°å‹‹ç« ?}
    K -->|æ˜¯| L[å»¶è¿Ÿ2ç§’å<br/>å¼¹çª—åº†ç¥è§£é”å‹‹ç« ]
    K -->|å¦| M[ç»§ç»­è®¡æ—¶]
    
    L --> N[å¼•å¯¼ç”¨æˆ·æŸ¥çœ‹å‹‹ç« å¢™]
    N --> M
    M --> C
    
    O[ç”¨æˆ·ç¦»å¼€é¡µé¢] --> P[åœæ­¢è®¡æ—¶]
    P --> Q[ä¸ŠæŠ¥æœ€ç»ˆé˜…è¯»æ—¶é•¿]
```

#### 10.2.3 å‹‹ç« å…‘æ¢æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥æ¿€åŠ±ä¸­å¿ƒ] --> B[æŸ¥çœ‹å½“å‰ç§¯åˆ†å’Œæ˜Ÿæ˜Ÿ]
    B --> C[æµè§ˆå¯å…‘æ¢å‹‹ç« åˆ—è¡¨]
    
    C --> D[å‹‹ç« å¡ç‰‡<br/>æ˜¾ç¤ºåç§°/æè¿°/æ‰€éœ€æ˜Ÿæ˜Ÿ]
    
    D --> E{å·²è§£é”?}
    E -->|æ˜¯| F[æ˜¾ç¤ºè§£é”æ—¶é—´<br/>ç°è‰²çŠ¶æ€/å·²æ‹¥æœ‰]
    E -->|å¦| G{æ˜Ÿæ˜Ÿæ•°é‡è¶³å¤Ÿ?}
    
    G -->|å¦| H[æ˜¾ç¤ºæ‰€éœ€æ˜Ÿæ˜Ÿ<br/>ç°è‰²çŠ¶æ€/æœªè¾¾æˆ]
    G -->|æ˜¯| I[é«˜äº®æ˜¾ç¤º<br/>å¯å…‘æ¢æŒ‰é’®]
    
    I --> J[ç”¨æˆ·ç‚¹å‡»å…‘æ¢]
    J --> K[å¼¹çª—äºŒæ¬¡ç¡®è®¤<br/>éœ€è¦ X æ˜Ÿæ˜Ÿ]
    
    K --> L{ç¡®è®¤å…‘æ¢?}
    L -->|å–æ¶ˆ| C
    L -->|ç¡®è®¤| M[æ‰£é™¤æ˜Ÿæ˜Ÿ]
    
    M --> N[è§£é”å‹‹ç« ]
    N --> O[æ’­æ”¾åŠ¨ç”»æ•ˆæœ<br/>ğŸ‰åº†ç¥]
    O --> P[å‹‹ç« æ·»åŠ åˆ°<br/>æˆ‘çš„å‹‹ç« å¢™]
    P --> Q[å¼¹å‡ºåˆ†äº«å¼•å¯¼<br/>åˆ†äº«åˆ°å¾®ä¿¡çŠ¶æ€/æœ‹å‹åœˆ]
```

#### 10.2.4 Flag æ‰“å¡ç³»ç»Ÿæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥ Flag æ‰“å¡é¡µé¢] --> B[åŠ è½½æœ¬å‘¨ Flag è®¾ç½®]
    
    B --> C{æ˜¯å¦å·²è®¾ç½®æœ¬å‘¨ Flag?}
    C -->|å¦| D[å¼•å¯¼ç”¨æˆ·è®¾ç½® Flag]
    C -->|æ˜¯| E[æ˜¾ç¤ºæœ¬å‘¨è¿›åº¦]
    
    D --> D1[è®¾ç½®æ¯å‘¨ç›®æ ‡]
    D1 --> D2[é€‰æ‹©é˜…è¯»æ—¶é•¿ç›®æ ‡<br/>egï¼š60åˆ†é’Ÿ/å‘¨]
    D1 --> D3[é€‰æ‹©AIèŠä¹¦æ¬¡æ•°ç›®æ ‡<br/>egï¼š5æ¬¡/å‘¨]
    D1 --> D4[é€‰æ‹©ç­”é¢˜æ¬¡æ•°ç›®æ ‡<br/>egï¼š10æ¬¡/å‘¨]
    
    D2 --> D5[ä¿å­˜ Flag]
    D3 --> D5
    D4 --> D5
    D5 --> E
    
    E --> E1[å±•ç¤º7å¤©è¿›åº¦æ¡<br/>å‘¨ä¸€~å‘¨æ—¥]
    E1 --> E2[æ˜¾ç¤ºä»Šæ—¥å®Œæˆæƒ…å†µ]
    
    E2 --> F{ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡?}
    F -->|æ˜¯| G[æ˜¾ç¤ºæ‰“å¡æˆåŠŸçŠ¶æ€<br/>âœ“ ä»Šæ—¥å·²å®Œæˆ]
    F -->|å¦| H[æ˜¾ç¤ºæ‰“å¡æŒ‰é’®]
    
    H --> I[ç”¨æˆ·ç‚¹å‡»æ‰“å¡]
    I --> J{æ£€æŸ¥ä»Šæ—¥ç›®æ ‡å®Œæˆåº¦}
    
    J -->|æœªè¾¾æ ‡| K[å¼¹çª—æç¤º<br/>é˜…è¯»ï¼š20/60åˆ†é’Ÿ<br/>èŠä¹¦ï¼š1/5æ¬¡<br/>ç­”é¢˜ï¼š3/10æ¬¡]
    J -->|å·²è¾¾æ ‡| L[æ‰“å¡æˆåŠŸ]
    
    K --> M[ç»§ç»­åŠªåŠ›æŒ‰é’®]
    M --> N[è¿”å›å­¦ä¹ ]
    
    L --> O[æ›´æ–°æœ¬å‘¨è¿›åº¦<br/>+1å¤©å®Œæˆ]
    O --> P{æœ¬å‘¨ Flag å®Œæˆ?}
    
    P -->|å¦| Q[æ˜¾ç¤ºæœ¬å‘¨å‰©ä½™å¤©æ•°]
    P -->|æ˜¯| R[ğŸ‰ æœ¬å‘¨ç›®æ ‡è¾¾æˆ]
    
    R --> S[å‘æ”¾é¢å¤–å¥–åŠ±<br/>+50ç§¯åˆ† +5æ˜Ÿæ˜Ÿ]
    S --> T[è§£é”æœ¬å‘¨å®Œæˆå‹‹ç« ]
    T --> U[åˆ†äº«æˆå°±åˆ°å¾®ä¿¡çŠ¶æ€]
```

#### 10.2.5 æ¿€åŠ±é€šçŸ¥æ¨é€æµç¨‹

```mermaid
flowchart TD
    A[è§¦å‘æ¿€åŠ±äº‹ä»¶] --> B{äº‹ä»¶ç±»å‹}
    
    B -->|é˜…è¯»10åˆ†é’Ÿ| C[å®æ—¶å¼¹çª—æç¤º<br/>+10ç§¯åˆ† +1æ˜Ÿæ˜Ÿ]
    B -->|ç­”é¢˜å…¨å¯¹| D[å®æ—¶å¼¹çª—æç¤º<br/>+20ç§¯åˆ† +3æ˜Ÿæ˜Ÿ<br/>å®Œç¾ç­”é¢˜ï¼]
    B -->|è§£é”æ–°å‹‹ç« | E[å»¶è¿Ÿ2ç§’å¼¹çª—<br/>ğŸ‰ æ­å–œè§£é”å‹‹ç« ]
    B -->|æœ¬å‘¨Flagå®Œæˆ| F[å¼¹çª—åº†ç¥<br/>æœ¬å‘¨ç›®æ ‡è¾¾æˆ]
    
    C --> G[è®°å½•é€šçŸ¥å·²è¯»çŠ¶æ€]
    D --> G
    E --> G
    F --> G
    
    G --> H[æ·»åŠ åˆ°æ¿€åŠ±ä¸­å¿ƒ<br/>é€šçŸ¥åˆ—è¡¨]
    H --> I[æ›´æ–°å°çº¢ç‚¹]
    
    E --> J{ç”¨æˆ·ç‚¹å‡»æŸ¥çœ‹?}
    J -->|æ˜¯| K[è·³è½¬å‹‹ç« å¢™]
    J -->|å¦| L[è‡ªåŠ¨å…³é—­]
    
    F --> M{ç”¨æˆ·ç‚¹å‡»åˆ†äº«?}
    M -->|æ˜¯| N[ç”Ÿæˆæˆå°±æµ·æŠ¥]
    M -->|å¦| L
    
    N --> O[ä¿å­˜/åˆ†äº«åˆ°å¾®ä¿¡]
```

### 10.3 å¤šè§’è‰²è´¦å·ç®¡ç†

#### 10.3.1 å¤šè§’è‰²è´¦å·ä½“ç³»æ¶æ„

```mermaid
flowchart TD
    A[å¾®ä¿¡ç™»å½•] --> B[åˆ›å»º/å…³è”ä¸»è´¦å·]
    B --> C{æ˜¯å¦å·²æœ‰è§’è‰²?}
    
    C -->|å¦| D[åˆ›å»ºé¦–ä¸ªè§’è‰²<br/>å®¶é•¿/å­©å­]
    C -->|æ˜¯| E[å±•ç¤ºè§’è‰²åˆ—è¡¨<br/>æœ€å¤š5ä¸ª]
    
    D --> F[è§’è‰²ç±»å‹é€‰æ‹©]
    F --> F1[å®¶é•¿è§’è‰²<br/>å®Œæ•´æƒé™]
    F --> F2[å­©å­è§’è‰²<br/>å—é™æƒé™]
    
    F1 --> G[å¡«å†™è§’è‰²ä¿¡æ¯<br/>æ˜µç§°/å¤´åƒ/å¹´é¾„]
    F2 --> G
    
    G --> H[ä¿å­˜è§’è‰²]
    H --> I[è®¾ä¸ºå½“å‰è§’è‰²]
    
    E --> J[é€‰æ‹©è§’è‰²ç™»å½•]
    J --> K[åˆ‡æ¢è§’è‰²]
    K --> L[æ¸…é™¤å‰ä¸€è§’è‰²ç¼“å­˜]
    L --> M[åŠ è½½æ–°è§’è‰²æ•°æ®]
    M --> N[æ›´æ–°å…¨å±€çŠ¶æ€]
    N --> O[é€šçŸ¥æ‰€æœ‰é¡µé¢åˆ·æ–°]
    O --> P[è¿›å…¥é¦–é¡µ]
```

#### 10.3.2 è§’è‰²åˆ‡æ¢æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡»æˆ‘çš„é¡µé¢<br/>è§’è‰²å¤´åƒ] --> B[å¼¹å‡ºè§’è‰²é€‰æ‹©é¢æ¿]
    B --> C[æ˜¾ç¤ºæ‰€æœ‰è§’è‰²å¡ç‰‡]
    
    C --> D[è§’è‰²1<br/>å½“å‰ä½¿ç”¨ âœ“]
    C --> E[è§’è‰²2<br/>å­©å­è´¦å·]
    C --> F[è§’è‰²3<br/>å­©å­è´¦å·]
    C --> G[+ åˆ›å»ºæ–°è§’è‰²<br/>æœ€å¤š5ä¸ª]
    
    E --> H[ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢]
    F --> H
    
    H --> I[æ˜¾ç¤ºåŠ è½½æç¤º<br/>åˆ‡æ¢ä¸­...]
    I --> J[è°ƒç”¨åç«¯åˆ‡æ¢æ¥å£]
    J --> K[æ¸…é™¤æœ¬åœ°ç¼“å­˜]
    
    K --> K1[æ¸…é™¤é˜…è¯»è¿›åº¦]
    K --> K2[æ¸…é™¤èŠå¤©å†å²]
    K --> K3[æ¸…é™¤AIä½¿ç”¨è®¡æ•°]
    K --> K4[æ¸…é™¤æ¿€åŠ±æ•°æ®]
    
    K1 --> L[ä¿å­˜æ–°è§’è‰²ä¿¡æ¯]
    K2 --> L
    K3 --> L
    K4 --> L
    
    L --> M[é‡ç½®é¡µé¢æ ˆ<br/>reLaunch]
    M --> N[è¿”å›é¦–é¡µ]
    N --> O[åŠ è½½æ–°è§’è‰²æ•°æ®]
    
    G --> P{è§’è‰²æ•°é‡<5?}
    P -->|æ˜¯| Q[è¿›å…¥åˆ›å»ºè§’è‰²é¡µé¢]
    P -->|å¦| R[æç¤ºæœ€å¤š5ä¸ªè§’è‰²]
```

#### 10.3.3 è§’è‰²æƒé™æ§åˆ¶æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·æ‰§è¡Œæ“ä½œ] --> B{æ£€æŸ¥å½“å‰è§’è‰²ç±»å‹}
    
    B -->|å®¶é•¿è§’è‰²| C[å®Œæ•´æƒé™]
    B -->|å­©å­è§’è‰²| D{æ£€æŸ¥é˜²æ²‰è¿·è®¾ç½®}
    
    C --> C1[å¯è®¿é—®æ‰€æœ‰åŠŸèƒ½]
    C --> C2[å¯è®¾ç½®é˜²æ²‰è¿·è§„åˆ™]
    C --> C3[å¯ç®¡ç†æ‰€æœ‰è§’è‰²]
    C --> C4[å¯æŸ¥çœ‹æ‰€æœ‰æ•°æ®ç»Ÿè®¡]
    
    D --> E{AIåŠŸèƒ½ä½¿ç”¨æ¬¡æ•°}
    E -->|æœªè¾¾ä¸Šé™| F[å…è®¸ä½¿ç”¨]
    E -->|å·²è¾¾ä¸Šé™| G[æ‹¦æˆªå¹¶æç¤º<br/>ä»Šæ—¥AIæ¬¡æ•°å·²ç”¨å®Œ]
    
    D --> H{é˜…è¯»æ—¶é•¿}
    H -->|æœªè¾¾ä¸Šé™| F
    H -->|å·²è¾¾ä¸Šé™| I[æ‹¦æˆªå¹¶æç¤º<br/>ä»Šæ—¥é˜…è¯»æ—¶é•¿å·²æ»¡]
    
    F --> J[è®°å½•ä½¿ç”¨æ•°æ®]
    J --> K[æ›´æ–°ç»Ÿè®¡]
    
    G --> L[æ¨é€é€šçŸ¥ç»™å®¶é•¿<br/>å­©å­è¾¾åˆ°ä½¿ç”¨ä¸Šé™]
    I --> L
```

#### 10.3.4 è§’è‰²æ•°æ®éš”ç¦»æœºåˆ¶

```mermaid
flowchart TD
    A[è§’è‰²åˆ‡æ¢å®Œæˆ] --> B[æ•°æ®éš”ç¦»å¤„ç†]
    
    B --> C[æœ¬åœ°ç¼“å­˜éš”ç¦»]
    C --> C1[é˜…è¯»è¿›åº¦<br/>book_progress_roleId]
    C --> C2[AIèŠå¤©å†å²<br/>chat_history_roleId]
    C --> C3[éŸ³è‰²åˆ—è¡¨<br/>voice_list_roleId]
    C --> C4[æ¿€åŠ±æ•°æ®<br/>incentive_roleId]
    
    B --> D[åç«¯æ•°æ®éš”ç¦»]
    D --> D1[ç”¨æˆ·è¡Œä¸ºæ•°æ®<br/>æŒ‰è§’è‰²IDåŒºåˆ†]
    D --> D2[å­¦ä¹ è¿›åº¦<br/>æŒ‰è§’è‰²IDåŒºåˆ†]
    D --> D3[é˜²æ²‰è¿·ç»Ÿè®¡<br/>æŒ‰è§’è‰²IDåŒºåˆ†]
    
    B --> E[æ¥å£è¯·æ±‚éš”ç¦»]
    E --> E1[Headeræºå¸¦<br/>X-Role-Idï¼šxxx]
    E1 --> E2[åç«¯éªŒè¯è§’è‰²å½’å±]
    E2 --> E3[è¿”å›å¯¹åº”è§’è‰²æ•°æ®]
    
    B --> F[æƒé™éªŒè¯]
    F --> F1{å®¶é•¿è§’è‰²?}
    F1 -->|æ˜¯| F2[å¯æŸ¥çœ‹æ‰€æœ‰å­è§’è‰²æ•°æ®]
    F1 -->|å¦| F3[ä»…æŸ¥çœ‹è‡ªå·±æ•°æ®]
```

### 10.4 å¾®ä¿¡çŠ¶æ€ä¸åˆ†äº«åŠŸèƒ½

#### 10.4.1 å¾®ä¿¡çŠ¶æ€è®¾ç½®ï¼ˆéœ€è°ƒç ”å¯è¡Œæ€§ï¼‰

```javascript
// services/wechat-status.js

/**
 * ç”Ÿæˆå¾®ä¿¡çŠ¶æ€å†…å®¹
 * @param {Object} params
 * @param {string} params.bookTitle - ä¹¦å
 * @param {string} params.slogan - å£ä»¤/æ ‡è¯­
 * @param {string} params.topic - è¯é¢˜æ ‡ç­¾
 */
export async function generateWechatStatus({ bookTitle, slogan, topic }) {
  try {
    const res = await wx.request({
      url: `${getApp().globalData.baseUrl}/share/generate-status`,
      method: 'POST',
      data: { book_title: bookTitle, slogan, topic },
      header: { 'Authorization': wx.getStorageSync('token') }
    })
    
    return res.data.data
  } catch (err) {
    console.error('ç”Ÿæˆå¾®ä¿¡çŠ¶æ€å¤±è´¥:', err)
    throw err
  }
}

/**
 * è®¾ç½®å¾®ä¿¡çŠ¶æ€ï¼ˆéœ€è¦å¾®ä¿¡å®˜æ–¹æ¥å£æ”¯æŒï¼‰
 * æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€è¦è°ƒç ”å¾®ä¿¡å°ç¨‹åºæ˜¯å¦æä¾›ç›¸å…³API
 */
export function setWechatStatus(statusData) {
  // TODO: è°ƒç ”å¾®ä¿¡çŠ¶æ€æ¥å£
  // å¦‚æœå¾®ä¿¡ä¸æ”¯æŒç›´æ¥è®¾ç½®çŠ¶æ€ï¼Œå¯ä»¥å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
  
  wx.setClipboardData({
    data: statusData.text,
    success: () => {
      wx.showModal({
        title: 'å·²å¤åˆ¶å£ä»¤',
        content: 'è¯·æ‰‹åŠ¨å‰å¾€å¾®ä¿¡è®¾ç½®çŠ¶æ€å¹¶ç²˜è´´',
        confirmText: 'çŸ¥é“äº†'
      })
    }
  })
}
```

#### 10.4.2 æœ‹å‹åœˆåˆ†äº«æµ·æŠ¥ç”Ÿæˆæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡»åˆ†äº«] --> B[é€‰æ‹©åˆ†äº«ç±»å‹]
    
    B --> B1[åˆ†äº«ä¹¦ç±]
    B --> B2[åˆ†äº«æˆå°±/å‹‹ç« ]
    B --> B3[åˆ†äº«é˜…è¯»å£ä»¤]
    
    B1 --> C[è·å–ä¹¦ç±ä¿¡æ¯<br/>å°é¢/ä¹¦å/ä½œè€…/ç®€ä»‹]
    B2 --> D[è·å–å‹‹ç« ä¿¡æ¯<br/>å›¾æ ‡/åç§°/æè¿°]
    B3 --> E[è·å–å£ä»¤å†…å®¹<br/>æ–‡æ¡ˆ/è¯é¢˜/èƒŒæ™¯]
    
    C --> F[Canvasç»˜åˆ¶æµ·æŠ¥]
    D --> F
    E --> F
    
    F --> G[ç»˜åˆ¶èƒŒæ™¯å›¾<br/>CDNè·å–ä¸»é¢˜èƒŒæ™¯]
    G --> H[ç»˜åˆ¶ä¹¦ç±å°é¢/å‹‹ç« å›¾æ ‡]
    H --> I[ç»˜åˆ¶æ–‡å­—å†…å®¹<br/>æ ‡é¢˜/æè¿°/å£ä»¤]
    I --> J[ç»˜åˆ¶è¯é¢˜æ ‡ç­¾<br/>#ä¼é¹…è¯»ä¼´]
    J --> K[ç»˜åˆ¶å°ç¨‹åºç <br/>æ‰«ç ç›´è¾¾]
    K --> L[ç»˜åˆ¶è£…é¥°å…ƒç´ <br/>è¾¹æ¡†/å›¾æ¡ˆ]
    
    L --> M[å¯¼å‡ºä¸´æ—¶å›¾ç‰‡]
    M --> N[é¢„è§ˆæµ·æŠ¥]
    
    N --> O[é€‰æ‹©æ“ä½œ]
    O --> O1[ä¿å­˜åˆ°ç›¸å†Œ]
    O --> O2[åˆ†äº«åˆ°å¾®ä¿¡å¥½å‹]
    O --> O3[åˆ†äº«åˆ°æœ‹å‹åœˆ]
    
    O1 --> P1{ç›¸å†Œæƒé™?}
    P1 -->|å·²æˆæƒ| P2[ä¿å­˜æˆåŠŸ]
    P1 -->|æœªæˆæƒ| P3[ç”³è¯·æƒé™]
    P3 --> P2
    
    O2 --> Q[è°ƒç”¨åˆ†äº«æ¥å£<br/>å‘é€å›¾ç‰‡æ¶ˆæ¯]
    O3 --> R[é•¿æŒ‰æµ·æŠ¥<br/>ç”¨æˆ·æ‰‹åŠ¨å‘æœ‹å‹åœˆ]
    
    P2 --> S[è®°å½•åˆ†äº«è¡Œä¸º<br/>æ•°æ®åŸ‹ç‚¹]
    Q --> S
    R --> S
```

#### 10.4.3 å¾®ä¿¡çŠ¶æ€ç”Ÿæˆæµç¨‹ï¼ˆéœ€è°ƒç ”æ¥å£å¯è¡Œæ€§ï¼‰

```mermaid
flowchart TD
    A[ç”¨æˆ·å®Œæˆé˜…è¯»/è§£é”æˆå°±] --> B[è§¦å‘åˆ†äº«å¼•å¯¼]
    B --> C[ç‚¹å‡»ç”Ÿæˆå¾®ä¿¡çŠ¶æ€]
    
    C --> D[é€‰æ‹©çŠ¶æ€ä¸»é¢˜]
    D --> D1[é˜…è¯»ä¸»é¢˜<br/>æˆ‘æ­£åœ¨è¯»xxx]
    D --> D2[æˆå°±ä¸»é¢˜<br/>è§£é”xxxå‹‹ç« ]
    D --> D3[å£ä»¤ä¸»é¢˜<br/>æ¯æ—¥ä¸€å¥]
    
    D1 --> E[AIç”Ÿæˆå£ä»¤æ–‡æ¡ˆ]
    D2 --> E
    D3 --> E
    
    E --> F[ç”Ÿæˆè¯é¢˜æ ‡ç­¾<br/>#ä¼é¹…è¯»ä¼´ #é˜…è¯»æ‰“å¡]
    F --> G[ç”ŸæˆèƒŒæ™¯å›¾ç‰‡<br/>ä¹¦ç±å°é¢/å‹‹ç« /ä¸»é¢˜å›¾]
    
    G --> H{å¾®ä¿¡çŠ¶æ€æ¥å£å¯ç”¨?}
    H -->|æ˜¯| I[è°ƒç”¨å¾®ä¿¡æ¥å£<br/>ç›´æ¥è®¾ç½®çŠ¶æ€]
    H -->|å¦ é™çº§æ–¹æ¡ˆ| J[å¤åˆ¶å£ä»¤åˆ°å‰ªè´´æ¿]
    
    I --> K[è®¾ç½®æˆåŠŸæç¤º]
    K --> L[è·³è½¬å¾®ä¿¡æŸ¥çœ‹çŠ¶æ€]
    
    J --> M[å¼¹çª—æç¤º<br/>å·²å¤åˆ¶å£ä»¤]
    M --> N[å¼•å¯¼æ‰‹åŠ¨ç²˜è´´<br/>æ‰“å¼€å¾®ä¿¡-æˆ‘-çŠ¶æ€-ç²˜è´´]
    
    N --> O[ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®å®Œæˆ]
    O --> P[è¿”å›å°ç¨‹åº<br/>è®°å½•åˆ†äº«è¡Œä¸º]
```

### 10.5 é˜²æ²‰è¿·ç³»ç»Ÿ

#### 10.5.1 é˜²æ²‰è¿·æ•´ä½“æ¶æ„

```mermaid
flowchart TD
    A[é˜²æ²‰è¿·ç³»ç»Ÿ] --> B[å®¶é•¿ç«¯è®¾ç½®]
    A --> C[å­©å­ç«¯é™åˆ¶]
    A --> D[æ•°æ®ç»Ÿè®¡ä¸é€šçŸ¥]
    
    B --> B1[é€‰æ‹©å­è§’è‰²]
    B --> B2[è®¾ç½®AIä½¿ç”¨æ¬¡æ•°é™åˆ¶<br/>0=ä¸é™åˆ¶]
    B --> B3[è®¾ç½®é˜…è¯»æ—¶é•¿é™åˆ¶<br/>0=ä¸é™åˆ¶]
    B --> B4[ä¿å­˜è®¾ç½®]
    B4 --> B5[å®æ—¶åŒæ­¥åˆ°å­è´¦å·]
    
    C --> C1[AIåŠŸèƒ½ä½¿ç”¨å‰æ£€æŸ¥]
    C --> C2[é˜…è¯»åŠŸèƒ½ä½¿ç”¨å‰æ£€æŸ¥]
    
    C1 --> E{ä»Šæ—¥AIä½¿ç”¨æ¬¡æ•°}
    E -->|< é™åˆ¶| F[å…è®¸ä½¿ç”¨<br/>è®¡æ•°+1]
    E -->|>= é™åˆ¶| G[æ‹¦æˆªå¹¶æç¤º<br/>ä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ]
    
    C2 --> H{ä»Šæ—¥é˜…è¯»æ—¶é•¿}
    H -->|< é™åˆ¶| I[å…è®¸ä½¿ç”¨<br/>æ—¶é•¿ç´¯è®¡]
    H -->|>= é™åˆ¶| J[æ‹¦æˆªå¹¶æç¤º<br/>ä»Šæ—¥æ—¶é•¿å·²æ»¡]
    
    G --> K[æ¨é€é€šçŸ¥ç»™å®¶é•¿]
    J --> K
    
    D --> D1[å®æ—¶ç»Ÿè®¡ä½¿ç”¨æ•°æ®<br/>æŒ‰å¤©/å‘¨/æœˆ]
    D --> D2[å®¶é•¿ç«¯æŸ¥çœ‹æŠ¥å‘Š<br/>ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨]
    D --> D3[å¼‚å¸¸è¡Œä¸ºé¢„è­¦<br/>çŸ­æ—¶é—´é¢‘ç¹åˆ‡æ¢è§’è‰²]
```

#### 10.5.2 é˜²æ²‰è¿·æ£€æŸ¥æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·æ“ä½œ<br/>AIèŠä¹¦/AIæ¨ä¹¦/AIåˆ›ä½œ] --> B[è·å–å½“å‰è§’è‰²ä¿¡æ¯]
    B --> C{è§’è‰²ç±»å‹}
    
    C -->|å®¶é•¿è§’è‰²| D[æ— é™åˆ¶<br/>ç›´æ¥ä½¿ç”¨]
    C -->|å­©å­è§’è‰²| E{æ˜¯å¦è®¾ç½®é˜²æ²‰è¿·?}
    
    E -->|å¦| D
    E -->|æ˜¯| F[è¯»å–é˜²æ²‰è¿·é…ç½®]
    
    F --> G[è·å–ä»Šæ—¥ä½¿ç”¨æ•°æ®<br/>ä»æœ¬åœ°ç¼“å­˜]
    G --> H{ä»Šæ—¥AIä½¿ç”¨æ¬¡æ•°}
    
    H -->|æœªè¾¾é™åˆ¶| I[å…è®¸ä½¿ç”¨]
    H -->|å·²è¾¾é™åˆ¶| J[å¼¹çª—æç¤º<br/>ä»Šæ—¥AIåŠŸèƒ½ä½¿ç”¨<br/>æ¬¡æ•°å·²è¾¾ä¸Šé™ X æ¬¡]
    
    I --> K[æ‰§è¡ŒAIåŠŸèƒ½]
    K --> L[ä½¿ç”¨æ¬¡æ•°+1]
    L --> M[æ›´æ–°æœ¬åœ°ç¼“å­˜]
    M --> N[ä¸ŠæŠ¥åç«¯]
    N --> O{æ˜¯å¦è¾¾åˆ°é€šçŸ¥é˜ˆå€¼?}
    
    O -->|æ˜¯| P[æ¨é€é€šçŸ¥ç»™å®¶é•¿<br/>å­©å­å·²ä½¿ç”¨Xæ¬¡AIåŠŸèƒ½]
    O -->|å¦| Q[ç»§ç»­ä½¿ç”¨]
    
    J --> R[æ˜¾ç¤ºæç¤ºæ–‡æ¡ˆ<br/>åŸ¹å…»è‰¯å¥½é˜…è¯»ä¹ æƒ¯]
    R --> S[è¿”å›ä¸Šä¸€é¡µ]
```

#### 10.5.3 å®¶é•¿ç«¯é˜²æ²‰è¿·è®¾ç½®æµç¨‹

```mermaid
flowchart TD
    A[å®¶é•¿è¿›å…¥é˜²æ²‰è¿·è®¾ç½®] --> B[é€‰æ‹©å­è§’è‰²]
    B --> C[æ˜¾ç¤ºå½“å‰é˜²æ²‰è¿·è®¾ç½®]
    
    C --> D[AIä½¿ç”¨æ¬¡æ•°é™åˆ¶<br/>å½“å‰ï¼šX æ¬¡/å¤©]
    C --> E[é˜…è¯»æ—¶é•¿é™åˆ¶<br/>å½“å‰ï¼šX åˆ†é’Ÿ/å¤©]
    
    D --> F[ä¿®æ”¹AIé™åˆ¶]
    E --> G[ä¿®æ”¹é˜…è¯»é™åˆ¶]
    
    F --> H[è¾“å…¥æ–°é™åˆ¶å€¼<br/>0=ä¸é™åˆ¶]
    G --> H
    
    H --> I[ç‚¹å‡»ä¿å­˜]
    I --> J[è°ƒç”¨åç«¯æ¥å£]
    J --> K[æ›´æ–°æ•°æ®åº“]
    K --> L[å®æ—¶æ¨é€ç»™å­è´¦å·]
    
    L --> M{å­è´¦å·æ˜¯å¦åœ¨çº¿?}
    M -->|æ˜¯| N[ç«‹å³ç”Ÿæ•ˆ<br/>æ›´æ–°æœ¬åœ°ç¼“å­˜]
    M -->|å¦| O[ä¸‹æ¬¡ç™»å½•æ—¶ç”Ÿæ•ˆ]
    
    N --> P[ä¿å­˜æˆåŠŸæç¤º]
    O --> P
    
    P --> Q[è¿”å›è®¾ç½®é¡µé¢]
```

### 10.6 æ•°æ®ç»Ÿè®¡ä¸åŸ‹ç‚¹

#### 10.6.1 åŸ‹ç‚¹ä½“ç³»æ¶æ„

```mermaid
flowchart TD
    A[ç”¨æˆ·è¡Œä¸º] --> B[åŸ‹ç‚¹è§¦å‘]
    
    B --> C[é¡µé¢è®¿é—®åŸ‹ç‚¹]
    B --> D[åŠŸèƒ½ä½¿ç”¨åŸ‹ç‚¹]
    B --> E[ä¸šåŠ¡è½¬åŒ–åŸ‹ç‚¹]
    
    C --> C1[onLoadï¼šé¡µé¢è·¯å¾„+å‚æ•°]
    C --> C2[onShowï¼šé¡µé¢å±•ç¤ºæ¬¡æ•°]
    C --> C3[onHideï¼šé¡µé¢åœç•™æ—¶é•¿]
    
    D --> D1[AIèŠä¹¦ï¼šæé—®æ¬¡æ•°/å“åº”æ—¶é•¿]
    D --> D2[AIæ¨ä¹¦ï¼šæŸ¥è¯¢å†…å®¹/æ¨èç»“æœ]
    D --> D3[éŸ³è‰²ä½¿ç”¨ï¼šéŸ³è‰²ID/ä½¿ç”¨åœºæ™¯]
    D --> D4[é˜…è¯»ï¼šä¹¦ç±ID/é˜…è¯»æ—¶é•¿/è¿›åº¦]
    D --> D5[æ¿€åŠ±ï¼šæ¿€åŠ±ç±»å‹/è·å¾—ç§¯åˆ†æ˜Ÿæ˜Ÿ]
    
    E --> E1[åˆ†äº«è½¬åŒ–ï¼šåˆ†äº«ç±»å‹/åˆ†äº«å¯¹è±¡]
    E --> E2[ä»˜è´¹è½¬åŒ–ï¼šä»˜è´¹å…¥å£/ä»˜è´¹é‡‘é¢]
    E --> E3[ç•™å­˜è½¬åŒ–ï¼šæ¬¡æ—¥/7æ—¥/30æ—¥ç•™å­˜]
    
    C1 --> F[åŸ‹ç‚¹é˜Ÿåˆ—]
    C2 --> F
    C3 --> F
    D1 --> F
    D2 --> F
    D3 --> F
    D4 --> F
    D5 --> F
    E1 --> F
    E2 --> F
    E3 --> F
    
    F --> G{é˜Ÿåˆ—é•¿åº¦}
    G -->|>= 50æ¡| H[ç«‹å³ä¸ŠæŠ¥]
    G -->|< 50æ¡| I[å®šæ—¶ä¸ŠæŠ¥<br/>æ¯30ç§’]
    
    H --> J[æ‰¹é‡å‘é€åˆ°åç«¯]
    I --> J
    
    J --> K{ä¸ŠæŠ¥æˆåŠŸ?}
    K -->|æ˜¯| L[æ¸…ç©ºé˜Ÿåˆ—]
    K -->|å¦| M[é‡æ–°å…¥é˜Ÿ<br/>ä¸‹æ¬¡é‡è¯•]
```

#### 10.6.2 å…³é”®ä¸šåŠ¡åŸ‹ç‚¹æµç¨‹

```mermaid
flowchart TD
    A[AIèŠä¹¦åŸ‹ç‚¹ç¤ºä¾‹] --> B[ç”¨æˆ·å‘èµ·æé—®]
    B --> C[è®°å½•å¼€å§‹æ—¶é—´]
    C --> D[è°ƒç”¨AIæ¥å£]
    D --> E[SSEæµå¼è¿”å›]
    E --> F[è®°å½•ç»“æŸæ—¶é—´]
    F --> G[è®¡ç®—å“åº”æ—¶é•¿]
    
    G --> H[åŸ‹ç‚¹æ•°æ®]
    H --> H1[event_nameï¼šai_chat]
    H --> H2[book_idï¼šxxx]
    H --> H3[question_lengthï¼š15]
    H --> H4[response_timeï¼š2500ms]
    H --> H5[user_idï¼šxxx]
    H --> H6[role_idï¼šxxx]
    H --> H7[session_idï¼šxxx]
    H --> H8[timestampï¼šxxx]
    
    H1 --> I[åŠ å…¥åŸ‹ç‚¹é˜Ÿåˆ—]
    H2 --> I
    H3 --> I
    H4 --> I
    H5 --> I
    H6 --> I
    H7 --> I
    H8 --> I
    
    I --> J[ç­‰å¾…æ‰¹é‡ä¸ŠæŠ¥]
```

#### 10.6.3 æ•°æ®ç»Ÿè®¡æŠ¥è¡¨åº”ç”¨

```mermaid
flowchart TD
    A[ç®¡ç†åå°] --> B[æ•°æ®ç»Ÿè®¡çœ‹æ¿]
    
    B --> C[ç”¨æˆ·æ•°æ®]
    B --> D[AIä½¿ç”¨æ•°æ®]
    B --> E[å†…å®¹æ•°æ®]
    B --> F[æ¿€åŠ±æ•°æ®]
    
    C --> C1[æ—¥æ´»/æœˆæ´»è¶‹åŠ¿]
    C --> C2[æ–°å¢ç”¨æˆ·æ•°]
    C --> C3[ç”¨æˆ·ç•™å­˜ç‡]
    C --> C4[ç”¨æˆ·ç”»åƒåˆ†å¸ƒ<br/>å¹´é¾„/å¹´çº§]
    
    D --> D1[AIèŠä¹¦ä½¿ç”¨æ¬¡æ•°/æ—¶é•¿]
    D --> D2[AIæ¨ä¹¦ä½¿ç”¨æ¬¡æ•°/å‘½ä¸­ç‡]
    D --> D3[AIåˆ›ä½œå„ç±»å‹ä½¿ç”¨é‡]
    D --> D4[éŸ³è‰²ä½¿ç”¨TOP10]
    
    E --> E1[ä¹¦ç±é˜…è¯»æ’è¡Œæ¦œ]
    E --> E2[å¹³å‡é˜…è¯»æ—¶é•¿]
    E --> E3[ä¹¦ç±å®Œæˆç‡]
    E --> E4[åˆ†äº«æ¬¡æ•°TOP10]
    
    F --> F1[æ¿€åŠ±å‘æ”¾æ€»é‡<br/>ç§¯åˆ†/æ˜Ÿæ˜Ÿ]
    F --> F2[å‹‹ç« è§£é”TOP10]
    F --> F3[Flagæ‰“å¡å®Œæˆç‡]
    F --> F4[æ¿€åŠ±è½¬åŒ–æ•ˆæœåˆ†æ]
    
    C1 --> G[å¯¼å‡ºExcelæŠ¥è¡¨]
    D1 --> G
    E1 --> G
    F1 --> G
```

### 10.7 AI åˆ›ä½œåŠŸèƒ½å®ç°

#### 10.7.1 AI åˆ›ä½œæ•´ä½“æ¶æ„

```mermaid
flowchart TD
    A[AIåˆ›ä½œå…¥å£] --> B[é¦–é¡µ]
    A --> C[å¬ä¹¦é¡µé¢]
    A --> D[æˆ‘çš„é¡µé¢]
    
    B --> E[AIåˆ›ä½œæ¨¡å—]
    C --> E
    D --> E
    
    E --> F[æƒ…èŠ‚ä»¿å†™]
    E --> G[æƒ…èŠ‚æ’ç”»åˆ›ä½œ]
    E --> H[è§’è‰²3D/2Då½¢è±¡åˆ›ä½œ]
    E --> I[æƒ…èŠ‚æ’­å®¢éŸ³é¢‘åˆ›ä½œ]
    
    F --> J[è¾“å…¥åˆ›ä½œå†…å®¹]
    G --> J
    H --> J
    I --> J
    
    J --> K{é˜²æ²‰è¿·æ£€æŸ¥}
    K -->|æœªè¾¾é™åˆ¶| L[è°ƒç”¨AIç”Ÿæˆæ¥å£]
    K -->|å·²è¾¾é™åˆ¶| M[æç¤ºå¹¶æ‹¦æˆª]
    
    L --> N[ç”Ÿæˆç»“æœ]
    N --> O[å±•ç¤º/è¯•å¬/ä¿å­˜]
    O --> P[åˆ†äº«ä½œå“]
```

#### 10.7.2 æƒ…èŠ‚ä»¿å†™æµç¨‹

```mermaid
flowchart TD
    A[é€‰æ‹©åŸä¹¦ç±æƒ…èŠ‚] --> B[æ˜¾ç¤ºåŸæƒ…èŠ‚å†…å®¹<br/>çº¦100-200å­—]
    B --> C[ç”¨æˆ·è¾“å…¥ä»¿å†™å†…å®¹]
    C --> D[ç‚¹å‡»æäº¤]
    
    D --> E{é˜²æ²‰è¿·æ£€æŸ¥}
    E -->|æœªè¾¾é™åˆ¶| F[æ˜¾ç¤ºåŠ è½½åŠ¨ç”»<br/>AIæ­£åœ¨åˆ†æ...]
    E -->|å·²è¾¾é™åˆ¶| G[æç¤ºä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ]
    
    F --> H[SSEæµå¼è¾“å‡º]
    H --> I[ç¬¬ä¸€é˜¶æ®µï¼šåˆ†ææ€è€ƒ<br/>æ­£åœ¨åˆ†ææ‚¨çš„åˆ›ä½œ...]
    I --> J[ç¬¬äºŒé˜¶æ®µï¼šç›¸ä¼¼åº¦è¯„åˆ†<br/>æƒ…èŠ‚ç»“æ„ç›¸ä¼¼åº¦ 85%]
    J --> K[ç¬¬ä¸‰é˜¶æ®µï¼šå¤šç»´åº¦è¯„ä»·<br/>åˆ›æ„æ€§ 90%<br/>é€»è¾‘æ€§ 85%<br/>è¯­è¨€è¡¨è¾¾ 88%]
    K --> L[ç¬¬å››é˜¶æ®µï¼šæ”¹è¿›å»ºè®®<br/>å»ºè®®åŠ å¼ºç»†èŠ‚æå†™...]
    
    L --> M[ç”Ÿæˆå®Œæˆ]
    M --> N[æ˜¾ç¤ºå®Œæ•´è¯„ä»·æŠ¥å‘Š]
    N --> O[ç”¨æˆ·æ“ä½œ]
    
    O --> O1[ä¿å­˜ä½œå“]
    O --> O2[é‡æ–°åˆ›ä½œ]
    O --> O3[åˆ†äº«ç»™å¥½å‹]
    
    O1 --> P[æ·»åŠ åˆ°æˆ‘çš„åˆ›ä½œé›†]
    O3 --> Q[ç”Ÿæˆåˆ†äº«å¡ç‰‡]
```

#### 10.7.3 æƒ…èŠ‚æ’ç”»åˆ›ä½œæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¾“å…¥æƒ…èŠ‚æè¿°] --> B[é€‰æ‹©ç”»é£]
    B --> B1[é»˜è®¤é£æ ¼]
    B --> B2[æ°´å½©é£æ ¼]
    B --> B3[æ²¹ç”»é£æ ¼]
    B --> B4[å¡é€šé£æ ¼]
    
    B1 --> C[ç‚¹å‡»ç”Ÿæˆ]
    B2 --> C
    B3 --> C
    B4 --> C
    
    C --> D{é˜²æ²‰è¿·æ£€æŸ¥}
    D -->|æœªè¾¾é™åˆ¶| E[æäº¤ç”Ÿæˆä»»åŠ¡]
    D -->|å·²è¾¾é™åˆ¶| F[æç¤ºå¹¶æ‹¦æˆª]
    
    E --> G[è¿”å›ä»»åŠ¡ID<br/>statusï¼šprocessing]
    G --> H[æ˜¾ç¤ºç”ŸæˆåŠ¨ç”»<br/>AIæ­£åœ¨ç»˜åˆ¶ä¸­...]
    
    H --> I[æ¯3ç§’è½®è¯¢ä¸€æ¬¡<br/>æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€]
    I --> J{ä»»åŠ¡çŠ¶æ€}
    
    J -->|processing| I
    J -->|completed| K[è·å–å›¾ç‰‡URL]
    J -->|failed| L[æ˜¾ç¤ºå¤±è´¥æç¤º<br/>é‡è¯•æŒ‰é’®]
    
    K --> M[æ˜¾ç¤ºç”Ÿæˆçš„æ’ç”»]
    M --> N[ç”¨æˆ·æ“ä½œ]
    
    N --> N1[ä¿å­˜åˆ°ç›¸å†Œ]
    N --> N2[é‡æ–°ç”Ÿæˆ]
    N --> N3[åˆ†äº«ä½œå“]
    N --> N4[è®¾ä¸ºå£çº¸]
    
    L --> O[ç”¨æˆ·ç‚¹å‡»é‡è¯•]
    O --> E
```

#### 10.7.4 è§’è‰²å½¢è±¡åˆ›ä½œæµç¨‹

```mermaid
flowchart TD
    A[é€‰æ‹©åˆ›ä½œç±»å‹] --> B[2Då½¢è±¡]
    A --> C[3Då½¢è±¡]
    
    B --> D[è¾“å…¥è§’è‰²ä¿¡æ¯]
    C --> D
    
    D --> E[è§’è‰²åç§°]
    D --> F[è§’è‰²æè¿°<br/>å¤–è²Œ/æ€§æ ¼/ç‰¹å¾]
    D --> G[å‚è€ƒä¹¦ç±è§’è‰²<br/>å¯é€‰]
    
    E --> H[ç‚¹å‡»ç”Ÿæˆ]
    F --> H
    G --> H
    
    H --> I{é˜²æ²‰è¿·æ£€æŸ¥}
    I -->|æœªè¾¾é™åˆ¶| J[AIè¡¥å……prompt<br/>ç»“åˆä¹¦ç±åœºæ™¯+ç”»é£]
    I -->|å·²è¾¾é™åˆ¶| K[æç¤ºå¹¶æ‹¦æˆª]
    
    J --> L[è°ƒç”¨ç”Ÿæˆæ¨¡å‹<br/>DALL-E/Midjourney]
    L --> M[å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—]
    M --> N[æ¯5ç§’è½®è¯¢çŠ¶æ€]
    
    N --> O{ç”ŸæˆçŠ¶æ€}
    O -->|processing| N
    O -->|completed| P[æ˜¾ç¤ºè§’è‰²å½¢è±¡]
    O -->|failed| Q[å¤±è´¥æç¤º]
    
    P --> R[ç”¨æˆ·æ“ä½œ]
    R --> R1[ä¿å­˜ä½œå“]
    R --> R2[è®¾ä¸ºè§’è‰²å¤´åƒ]
    R --> R3[åˆ†äº«]
    R --> R4[ç»§ç»­ä¼˜åŒ–<br/>é‡æ–°æè¿°]
```

#### 10.7.5 æ’­å®¢éŸ³é¢‘åˆ›ä½œæµç¨‹

```mermaid
flowchart TD
    A[è¾“å…¥æ’­å®¢è„šæœ¬] --> B[é€‰æ‹©éŸ³è‰²]
    B --> B1[ç³»ç»Ÿæ’­å®¢éŸ³è‰²]
    B --> B2[æˆ‘çš„éŸ³è‰²]
    
    B1 --> C[ç‚¹å‡»ç”Ÿæˆ]
    B2 --> C
    
    C --> D{é˜²æ²‰è¿·æ£€æŸ¥}
    D -->|æœªè¾¾é™åˆ¶| E[AIä¼˜åŒ–è„šæœ¬<br/>å¢åŠ é’å°‘å¹´é€‚é…å†…å®¹]
    D -->|å·²è¾¾é™åˆ¶| F[æç¤ºå¹¶æ‹¦æˆª]
    
    E --> G[è°ƒç”¨TTSè¯­éŸ³åˆæˆ]
    G --> H[ç”ŸæˆéŸ³é¢‘æ–‡ä»¶]
    H --> I[ä¸Šä¼ åˆ°CDN]
    I --> J[è¿”å›éŸ³é¢‘URL]
    
    J --> K[æ˜¾ç¤ºæ’­æ”¾å™¨]
    K --> L[ç”¨æˆ·è¯•å¬]
    L --> M[ç”¨æˆ·æ“ä½œ]
    
    M --> M1[ä¿å­˜åˆ°æˆ‘çš„ä½œå“]
    M --> M2[ä¸‹è½½éŸ³é¢‘]
    M --> M3[åˆ†äº«]
    M --> M4[é‡æ–°ç”Ÿæˆ<br/>æ¢éŸ³è‰²/æ”¹è„šæœ¬]
    
    M1 --> N[æ·»åŠ åˆ°æ’­å®¢åº“]
    M3 --> O[ç”Ÿæˆåˆ†äº«å¡ç‰‡<br/>å«éŸ³é¢‘äºŒç»´ç ]
```

#### 10.7.2 AI åˆ›ä½œé¡µé¢å®ç°ï¼ˆæƒ…èŠ‚æ’ç”»ç¤ºä¾‹ï¼‰

```javascript
// pages/ai-create/illustration/illustration.js
import { createIllustration, queryIllustrationStatus } from '../../../services/ai-create'
import { ParentalControl } from '../../../utils/parental-control'
import statsTracker from '../../../utils/stats-tracker'

Page({
  data: {
    bookId: '',
    bookInfo: {},
    plotDescription: '',
    selectedStyle: 'default',
    styles: [
      { value: 'default', label: 'é»˜è®¤', icon: 'ğŸ¨' },
      { value: 'watercolor', label: 'æ°´å½©', icon: 'ğŸ–Œï¸' },
      { value: 'oil', label: 'æ²¹ç”»', icon: 'ğŸ–¼ï¸' },
      { value: 'cartoon', label: 'å¡é€š', icon: 'ğŸ­' }
    ],
    isGenerating: false,
    generatedImageUrl: null,
    taskId: null,
    pollTimer: null
  },

  onLoad(options) {
    this.setData({ bookId: options.bookId })
    this.loadBookInfo()
    statsTracker.trackPageView('/pages/ai-create/illustration/illustration', { bookId: options.bookId })
  },

  async loadBookInfo() {
    // åŠ è½½ä¹¦ç±ä¿¡æ¯é€»è¾‘
  },

  onStyleChange(e) {
    this.setData({ selectedStyle: e.detail.value })
  },

  onPlotInput(e) {
    this.setData({ plotDescription: e.detail.value })
  },

  async onGenerate() {
    const { plotDescription, selectedStyle, bookId } = this.data
    
    if (!plotDescription.trim()) {
      wx.showToast({ title: 'è¯·è¾“å…¥æƒ…èŠ‚æè¿°', icon: 'none' })
      return
    }
    
    // æ£€æŸ¥é˜²æ²‰è¿·é™åˆ¶
    const checkResult = await ParentalControl.checkAIUsageLimit()
    if (!checkResult.allowed) {
      ParentalControl.showLimitNotification(checkResult.message)
      return
    }
    
    this.setData({ isGenerating: true, generatedImageUrl: null })
    
    try {
      const result = await createIllustration({
        bookId,
        plotDescription,
        style: selectedStyle
      })
      
      this.setData({ taskId: result.task_id })
      
      // è®°å½• AI ä½¿ç”¨
      ParentalControl.recordAIUsage()
      
      // å¼€å§‹è½®è¯¢æŸ¥è¯¢çŠ¶æ€
      this.startPolling()
      
      // åŸ‹ç‚¹
      statsTracker.track('ai_create_illustration', {
        book_id: bookId,
        style: selectedStyle,
        description_length: plotDescription.length
      })
    } catch (err) {
      this.setData({ isGenerating: false })
      wx.showToast({ title: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'none' })
    }
  },

  startPolling() {
    this.pollTimer = setInterval(async () => {
      await this.checkStatus()
    }, 3000) // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡
  },

  async checkStatus() {
    const { taskId } = this.data
    
    try {
      const result = await queryIllustrationStatus(taskId)
      
      if (result.status === 'completed') {
        clearInterval(this.pollTimer)
        this.setData({
          isGenerating: false,
          generatedImageUrl: result.image_url
        })
        wx.showToast({ title: 'ç”ŸæˆæˆåŠŸï¼', icon: 'success' })
      } else if (result.status === 'failed') {
        clearInterval(this.pollTimer)
        this.setData({ isGenerating: false })
        wx.showToast({ title: 'ç”Ÿæˆå¤±è´¥', icon: 'none' })
      }
      // processing çŠ¶æ€ç»§ç»­è½®è¯¢
    } catch (err) {
      console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', err)
    }
  },

  onSaveImage() {
    const { generatedImageUrl } = this.data
    
    if (!generatedImageUrl) return
    
    wx.downloadFile({
      url: generatedImageUrl,
      success: (res) => {
        if (res.statusCode === 200) {
          wx.saveImageToPhotosAlbum({
            filePath: res.tempFilePath,
            success: () => {
              wx.showToast({ title: 'å·²ä¿å­˜åˆ°ç›¸å†Œ', icon: 'success' })
            },
            fail: () => {
              wx.showToast({ title: 'ä¿å­˜å¤±è´¥', icon: 'none' })
            }
          })
        }
      }
    })
  },

  onShareImage() {
    // åˆ†äº«ç”Ÿæˆçš„æ’ç”»
    return {
      title: 'æˆ‘çš„AIåˆ›ä½œ - ä¼é¹…è¯»ä¼´',
      imageUrl: this.data.generatedImageUrl
    }
  },

  onUnload() {
    if (this.pollTimer) {
      clearInterval(this.pollTimer)
    }
  }
})
```

---

## 11. å¾®ä¿¡å°ç¨‹åºé…ç½®æ¸…å•

### 11.1 æœåŠ¡å™¨åŸŸåé…ç½®

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å° > å¼€å‘ > å¼€å‘ç®¡ç† > å¼€å‘è®¾ç½® > æœåŠ¡å™¨åŸŸåä¸­é…ç½®ï¼š

#### request åˆæ³•åŸŸå

```
https://api.penguinreader.com       # ä¸»æ¥å£åŸŸå
https://ai.penguinreader.com        # AIæœåŠ¡åŸŸå
https://cdn.penguinreader.com       # CDNèµ„æºåŸŸå
https://img-cdn.penguinreader.com   # å›¾ç‰‡CDN
https://voice-cdn.penguinreader.com # éŸ³è‰²CDN
```

#### uploadFile åˆæ³•åŸŸå

```
https://api.penguinreader.com       # éŸ³è‰²ä¸Šä¼ 
https://upload.penguinreader.com    # ä¸“ç”¨ä¸Šä¼ åŸŸå
```

#### downloadFile åˆæ³•åŸŸå

```
https://cdn.penguinreader.com       # é™æ€èµ„æºä¸‹è½½
https://img-cdn.penguinreader.com   # å›¾ç‰‡ä¸‹è½½
https://voice-cdn.penguinreader.com # éŸ³é¢‘ä¸‹è½½
```

#### socket åˆæ³•åŸŸåï¼ˆå¦‚éœ€ WebSocketï¼‰

```
wss://ai.penguinreader.com          # AIå®æ—¶é€šä¿¡ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
```

### 11.2 ä¸šåŠ¡åŸŸåé…ç½®

å¦‚æœéœ€è¦åœ¨å°ç¨‹åºå†…æ‰“å¼€ web-viewï¼Œéœ€è¦é…ç½®ä¸šåŠ¡åŸŸåï¼š

```
https://h5.penguinreader.com        # H5é¡µé¢åŸŸå
```

### 11.3 æ’ä»¶ä¸ç¬¬ä¸‰æ–¹æœåŠ¡

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å° > è®¾ç½® > ç¬¬ä¸‰æ–¹è®¾ç½® > æ’ä»¶ç®¡ç†ä¸­æ·»åŠ ï¼š

- **è…¾è®¯åœ°å›¾æ’ä»¶**ï¼ˆå¦‚éœ€å®šä½ç­¾åˆ°åŠŸèƒ½ï¼‰
- **AIå¯¹è¯æ’ä»¶**ï¼ˆå¦‚ä½¿ç”¨ç¬¬ä¸‰æ–¹AIæœåŠ¡ï¼‰

### 11.4 æƒé™ç”³è¯·

éœ€è¦åœ¨ `app.json` ä¸­å£°æ˜å¹¶åœ¨å¾®ä¿¡åå°ç”³è¯·çš„æƒé™ï¼š

```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "ç”¨äºç­¾åˆ°åŠŸèƒ½è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯"
    },
    "scope.record": {
      "desc": "ç”¨äºå½•åˆ¶ä¸ªæ€§åŒ–éŸ³è‰²"
    },
    "scope.writePhotosAlbum": {
      "desc": "ç”¨äºä¿å­˜åˆ†äº«æµ·æŠ¥å’ŒAIåˆ›ä½œä½œå“"
    }
  }
}
```

---

## 12. æ€§èƒ½ä¼˜åŒ–ä¸“é¡¹ï¼ˆä¼é¹…è¯»ä¼´åœºæ™¯ï¼‰

### 12.1 é¦–å±åŠ è½½ä¼˜åŒ–

#### 12.1.1 é¦–é¡µåŠ è½½ç­–ç•¥æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·æ‰“å¼€å°ç¨‹åº] --> B[è¿›å…¥é¦–é¡µ onLoad]
    B --> C[è¯»å–æœ¬åœ°ç¼“å­˜]
    
    C --> D{ç¼“å­˜å­˜åœ¨ä¸”æœªè¿‡æœŸ?}
    D -->|æ˜¯| E[ç«‹å³æ¸²æŸ“ç¼“å­˜æ•°æ®<br/>æ˜¾ç¤ºå†…å®¹]
    D -->|å¦| F[æ˜¾ç¤ºéª¨æ¶å±<br/>åŠ è½½å ä½]
    
    E --> G[å¹¶è¡Œå‘èµ·3ä¸ªæ¥å£è¯·æ±‚]
    F --> G
    
    G --> G1[è¯·æ±‚Banneræ•°æ®<br/>ttlï¼š10åˆ†é’Ÿ]
    G --> G2[è¯·æ±‚æ¨èä¹¦ç±<br/>ttlï¼š5åˆ†é’Ÿ]
    G --> G3[è¯·æ±‚åˆ†ç±»æ•°æ®<br/>ttlï¼š30åˆ†é’Ÿ]
    
    G1 --> H[Promise.allç­‰å¾…æ‰€æœ‰è¯·æ±‚]
    G2 --> H
    G3 --> H
    
    H --> I[æ›´æ–°é¡µé¢æ•°æ®<br/>éšè—éª¨æ¶å±]
    I --> J[æ›´æ–°æœ¬åœ°ç¼“å­˜<br/>è®°å½•æ—¶é—´æˆ³]
    J --> K[é¦–å±åŠ è½½å®Œæˆ]
    
    K --> L{åŠ è½½è€—æ—¶ç›‘æ§}
    L -->|< 3ç§’| M[æ€§èƒ½åˆæ ¼]
    L -->|>= 3ç§’| N[ä¸ŠæŠ¥æ…¢åŠ è½½æ—¥å¿—]
```

#### 12.1.2 æ¥å£è¯·æ±‚ç¼“å­˜ç­–ç•¥

```mermaid
flowchart TD
    A[è°ƒç”¨ requestWithCache] --> B[æ£€æŸ¥æœ¬åœ°ç¼“å­˜]
    
    B --> C{ç¼“å­˜å­˜åœ¨?}
    C -->|å¦| D[ç›´æ¥å‘èµ·ç½‘ç»œè¯·æ±‚]
    C -->|æ˜¯| E{ç¼“å­˜æœªè¿‡æœŸ?}
    
    E -->|å¦| D
    E -->|æ˜¯| F[ç«‹å³è¿”å›ç¼“å­˜æ•°æ®<br/>fromï¼šcache]
    
    F --> G[åå°é™é»˜åˆ·æ–°<br/>å‘èµ·ç½‘ç»œè¯·æ±‚]
    
    D --> H[ç½‘ç»œè¯·æ±‚]
    G --> H
    
    H --> I{è¯·æ±‚æˆåŠŸ?}
    I -->|æ˜¯| J[ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜<br/>å¸¦æ—¶é—´æˆ³]
    I -->|å¦| K{æœ‰ç¼“å­˜å¯ç”¨?}
    
    J --> L[è¿”å›æœ€æ–°æ•°æ®<br/>fromï¼šnetwork]
    K -->|æ˜¯| M[è¿”å›è¿‡æœŸç¼“å­˜<br/>fromï¼šstale-cache]
    K -->|å¦| N[æŠ›å‡ºé”™è¯¯]
    
    L --> O[æ›´æ–°UI]
    M --> O
```

#### 12.1.3 åˆ†åŒ…åŠ è½½ç­–ç•¥

```mermaid
flowchart TD
    A[å°ç¨‹åºåŒ…ç»“æ„] --> B[ä¸»åŒ… < 2MB]
    A --> C[åˆ†åŒ…]
    
    B --> B1[pages/index é¦–é¡µ]
    B --> B2[pages/book-detail ä¹¦ç±è¯¦æƒ…]
    B --> B3[pages/reading å¬ä¹¦é¡µ]
    B --> B4[pages/profile æˆ‘çš„]
    B --> B5[å…¬å…±ç»„ä»¶]
    B --> B6[å…¬å…±utils]
    
    C --> C1[AIåŒ… packages/ai]
    C --> C2[æ¿€åŠ±åŒ… packages/incentive]
    C --> C3[éŸ³è‰²åŒ… packages/voice]
    
    C1 --> C11[AIèŠä¹¦]
    C1 --> C12[AIæ¨ä¹¦]
    C1 --> C13[AIåˆ›ä½œ]
    
    C2 --> C21[æ¿€åŠ±ä¸­å¿ƒ]
    C2 --> C22[Flagæ‰“å¡]
    C2 --> C23[å‹‹ç« ç³»ç»Ÿ]
    
    C3 --> C31[éŸ³è‰²ç®¡ç†]
    C3 --> C32[éŸ³è‰²å½•åˆ¶]
    
    D[åˆ†åŒ…é¢„åŠ è½½è§„åˆ™] --> E[é¦–é¡µé¢„åŠ è½½ AIåŒ…]
    D --> F[å¬ä¹¦é¡µé¢„åŠ è½½ AIåŒ…+éŸ³è‰²åŒ…]
    D --> G[æ¿€åŠ±ä¸­å¿ƒé¢„åŠ è½½ æ¿€åŠ±åŒ…]
```

### 12.2 é•¿åˆ—è¡¨ä¼˜åŒ–

#### 12.2.1 è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“æµç¨‹

```mermaid
flowchart TD
    A[ä¹¦ç±åˆ—è¡¨æ•°æ®<br/>1000æœ¬ä¹¦ç±] --> B[è®¡ç®—å¯è§†åŒºåŸŸ]
    
    B --> C[å±å¹•é«˜åº¦ï¼š667px<br/>å•é¡¹é«˜åº¦ï¼š200px]
    C --> D[å¯è§†æ•°é‡ï¼š667Ã·200 â‰ˆ 4é¡¹]
    
    D --> E[æ¸²æŸ“ç­–ç•¥]
    E --> F[å¯è§†åŒºåŸŸä¸Šæ–¹+2é¡¹<br/>ç¼“å†²åŒº]
    E --> G[å¯è§†åŒºåŸŸ 4é¡¹<br/>å®é™…æ¸²æŸ“]
    E --> H[å¯è§†åŒºåŸŸä¸‹æ–¹+2é¡¹<br/>ç¼“å†²åŒº]
    
    F --> I[æ€»æ¸²æŸ“ï¼š4+2+2=8é¡¹]
    G --> I
    H --> I
    
    I --> J[ç”¨æˆ·æ»šåŠ¨åˆ—è¡¨]
    J --> K[ç›‘å¬scrolläº‹ä»¶]
    K --> L[è®¡ç®—scrollTop]
    L --> M[é‡æ–°è®¡ç®—startIndex/endIndex]
    M --> N[æ›´æ–°å¯è§†é¡¹æ•°ç»„<br/>visibleItems]
    N --> O[setDataæ›´æ–°è§†å›¾<br/>åªæ›´æ–°8é¡¹]
    
    O --> P{æ€§èƒ½æå‡}
    P --> Q[åŸæ–¹æ¡ˆï¼šæ¸²æŸ“1000é¡¹<br/>æ€§èƒ½å·®/å¡é¡¿]
    P --> R[è™šæ‹Ÿåˆ—è¡¨ï¼šæ¸²æŸ“8é¡¹<br/>æµç•…/é«˜æ€§èƒ½]
```

#### 12.2.2 åˆ†é¡µåŠ è½½æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥ä¹¦ç±åˆ—è¡¨] --> B[åŠ è½½ç¬¬1é¡µ<br/>20æ¡æ•°æ®]
    B --> C[æ¸²æŸ“åˆ—è¡¨]
    C --> D[ç”¨æˆ·å‘ä¸‹æ»šåŠ¨]
    
    D --> E{æ»šåŠ¨åˆ°åº•éƒ¨?}
    E -->|å¦| D
    E -->|æ˜¯| F{è¿˜æœ‰æ›´å¤šæ•°æ®?}
    
    F -->|å¦| G[æ˜¾ç¤º"æ²¡æœ‰æ›´å¤šäº†"]
    F -->|æ˜¯| H[æ˜¾ç¤ºåŠ è½½ä¸­...]
    
    H --> I[è¯·æ±‚ä¸‹ä¸€é¡µæ•°æ®<br/>page+1]
    I --> J{è¯·æ±‚æˆåŠŸ?}
    
    J -->|æ˜¯| K[è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾<br/>concatæ–°æ•°æ®]
    J -->|å¦| L[æ˜¾ç¤ºåŠ è½½å¤±è´¥<br/>ç‚¹å‡»é‡è¯•]
    
    K --> M[æ›´æ–°é¡µç  page+1]
    M --> N[éšè—åŠ è½½æç¤º]
    N --> D
    
    L --> O[ç”¨æˆ·ç‚¹å‡»é‡è¯•]
    O --> I
```

### 12.3 setData ä¼˜åŒ–

#### 12.3.1 setData ä¼˜åŒ–ç­–ç•¥

```mermaid
flowchart TD
    A[setData æ€§èƒ½é—®é¢˜] --> B[é—®é¢˜1ï¼šé¢‘ç¹è°ƒç”¨<br/>AIæµå¼è¾“å‡ºæ¯ç§’æ•°åæ¬¡]
    A --> C[é—®é¢˜2ï¼šæ•°æ®é‡å¤§<br/>æ•´ä¸ªæ•°ç»„ä¼ è¾“]
    A --> D[é—®é¢˜3ï¼šåµŒå¥—å±‚çº§æ·±<br/>åºåˆ—åŒ–è€—æ—¶]
    
    B --> E[è§£å†³æ–¹æ¡ˆ1ï¼šèŠ‚æµ]
    E --> F[100mså†…åªæ‰§è¡Œä¸€æ¬¡<br/>åˆå¹¶å¤šæ¬¡æ›´æ–°]
    
    C --> G[è§£å†³æ–¹æ¡ˆ2ï¼šå±€éƒ¨æ›´æ–°]
    G --> H[ä¸ä¼ æ•´ä¸ªæ•°ç»„<br/>åªæ›´æ–°å…·ä½“ç´¢å¼•]
    G --> I[ä½¿ç”¨è·¯å¾„æ–¹å¼<br/>messages[10].content]
    
    D --> J[è§£å†³æ–¹æ¡ˆ3ï¼šå‡å°‘å±‚çº§]
    J --> K[æ‰å¹³åŒ–æ•°æ®ç»“æ„<br/>é¿å…æ·±å±‚åµŒå¥—]
    
    F --> L[å®é™…åº”ç”¨]
    I --> L
    K --> L
    
    L --> M[AIèŠä¹¦åœºæ™¯]
    M --> N[ç¼“å­˜AIè¿”å›å†…å®¹<br/>aiContentBuffer]
    N --> O[100msèŠ‚æµæ›´æ–°<br/>throttleå‡½æ•°]
    O --> P[åªæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯<br/>messages[last].content]
    P --> Q[æ€§èƒ½æå‡10å€]
```

#### 12.3.2 AIèŠä¹¦ setData ä¼˜åŒ–æµç¨‹

```mermaid
flowchart TD
    A[AIè¿”å›æ•°æ®å—<br/>æ¯100msä¸€æ¬¡] --> B[è¿½åŠ åˆ°buffer<br/>aiContentBuffer += chunk]
    B --> C{è·ä¸Šæ¬¡æ›´æ–°<br/>>= 100ms?}
    
    C -->|å¦| D[è·³è¿‡æœ¬æ¬¡æ›´æ–°<br/>ç»§ç»­ç¼“å†²]
    C -->|æ˜¯| E[è§¦å‘setData]
    
    D --> A
    
    E --> F[è®¡ç®—æ¶ˆæ¯ç´¢å¼•<br/>lastIndex = messages.length-1]
    F --> G[ä½¿ç”¨è·¯å¾„æ–¹å¼æ›´æ–°<br/>ä¸ä¼ æ•´ä¸ªæ•°ç»„]
    G --> H[setData<br/>messages[lastIndex].content]
    
    H --> I[è§†å›¾æ›´æ–°<br/>åªé‡æ–°æ¸²æŸ“è¯¥æ¶ˆæ¯]
    I --> J[è®°å½•æ›´æ–°æ—¶é—´<br/>lastTime = now]
    J --> K{æµå¼ç»“æŸ?}
    
    K -->|å¦| A
    K -->|æ˜¯| L[æœ€ç»ˆæ›´æ–°å®Œæˆ]
```

#### 12.3.3 æ€§èƒ½å¯¹æ¯”

```mermaid
flowchart LR
    A[ä¼˜åŒ–å‰] --> B[æ¯æ¬¡chunkéƒ½setData<br/>1ç§’30æ¬¡]
    B --> C[ä¼ æ•´ä¸ªmessagesæ•°ç»„<br/>åŒ…å«å†å²æ‰€æœ‰æ¶ˆæ¯]
    C --> D[æ€§èƒ½ï¼šå¡é¡¿<br/>è€—æ—¶ï¼š300ms/æ¬¡]
    
    E[ä¼˜åŒ–å] --> F[èŠ‚æµ100ms<br/>1ç§’10æ¬¡]
    F --> G[åªæ›´æ–°æœ€åä¸€æ¡<br/>messages[last].content]
    G --> H[æ€§èƒ½ï¼šæµç•…<br/>è€—æ—¶ï¼š30ms/æ¬¡]
    
    D --> I[ç”¨æˆ·ä½“éªŒï¼šå·®]
    H --> J[ç”¨æˆ·ä½“éªŒï¼šå¥½]
```

---

## 13. æµ‹è¯•ä¸éªŒæ”¶

### 13.1 æµ‹è¯•æµç¨‹ä½“ç³»

```mermaid
flowchart TD
    A[æµ‹è¯•é˜¶æ®µ] --> B[å¼€å‘è‡ªæµ‹]
    A --> C[æµ‹è¯•å›¢é˜Ÿæµ‹è¯•]
    A --> D[é¢„å‘å¸ƒæµ‹è¯•]
    A --> E[ç°åº¦æµ‹è¯•]
    
    B --> B1[å•å…ƒæµ‹è¯•<br/>å·¥å…·å‡½æ•°/ç»„ä»¶]
    B --> B2[åŠŸèƒ½è‡ªæµ‹<br/>æ ¸å¿ƒä¸šåŠ¡æµç¨‹]
    B --> B3[å…¼å®¹æ€§æµ‹è¯•<br/>iOS/AndroidçœŸæœº]
    
    C --> C1[åŠŸèƒ½æµ‹è¯•<br/>æŒ‰P0/P1/P2ä¼˜å…ˆçº§]
    C --> C2[å…¼å®¹æ€§æµ‹è¯•<br/>å¤šæœºå‹/å¤šç‰ˆæœ¬]
    C --> C3[æ€§èƒ½æµ‹è¯•<br/>åŠ è½½é€Ÿåº¦/æµç•…åº¦]
    C --> C4[å®‰å…¨æµ‹è¯•<br/>æ¥å£/æƒé™]
    
    D --> D1[é¢„å‘å¸ƒç¯å¢ƒ<br/>çœŸå®æ•°æ®æµ‹è¯•]
    D --> D2[å…¨é‡åŠŸèƒ½å›å½’]
    D --> D3[å‹åŠ›æµ‹è¯•<br/>å¹¶å‘åœºæ™¯]
    
    E --> E1[5%ç”¨æˆ·ç°åº¦]
    E --> E2[ç›‘æ§æ•°æ®æŒ‡æ ‡]
    E --> E3{é—®é¢˜å‘ç°?}
    
    E3 -->|æ˜¯| F[ä¿®å¤å¹¶é‡æ–°æµ‹è¯•]
    E3 -->|å¦| G[æ‰©å¤§ç°åº¦èŒƒå›´]
    
    F --> D
    G --> H[20%ç”¨æˆ·]
    H --> I[100%å…¨é‡å‘å¸ƒ]
```

### 13.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

#### 13.1.1 P0 åŠŸèƒ½ï¼ˆé‡Œç¨‹ç¢‘ä¸€ï¼‰

- [ ] **AIåˆ›ä½œ**
  - [ ] æƒ…èŠ‚ä»¿å†™ï¼šè¾“å…¥ã€ç”Ÿæˆã€è¯„åˆ†ã€ä¿å­˜
  - [ ] æƒ…èŠ‚æ’ç”»ï¼šç”Ÿæˆã€æ ·å¼åˆ‡æ¢ã€ä¿å­˜ã€åˆ†äº«
  - [ ] è§’è‰²å½¢è±¡ï¼š2D/3D åˆ‡æ¢ã€ç”Ÿæˆã€ä¿å­˜
  - [ ] æ’­å®¢éŸ³é¢‘ï¼šç”Ÿæˆã€æ’­æ”¾ã€ä¸‹è½½

- [ ] **AIéŸ³è‰²**
  - [ ] éŸ³è‰²å½•åˆ¶ï¼šæƒé™ç”³è¯·ã€å½•åˆ¶ã€ä¸Šä¼ 
  - [ ] éŸ³è‰²è¯•å¬ï¼šæ’­æ”¾ã€åˆ‡æ¢
  - [ ] éŸ³è‰²åˆ†äº«ï¼šç”Ÿæˆåˆ†äº«å¡ç‰‡ã€æ¥æ”¶
  - [ ] éŸ³è‰²æ‰“åˆ†ï¼šè¯„åˆ†ã€åé¦ˆæ¨é€

- [ ] **è´¦å·ç®¡ç†**
  - [ ] å¤šè§’è‰²åˆ›å»ºï¼šæœ€å¤š5ä¸ªè§’è‰²
  - [ ] è§’è‰²åˆ‡æ¢ï¼šåˆ‡æ¢ã€æ•°æ®éš”ç¦»
  - [ ] æƒé™ç®¡ç†ï¼šçˆ¶æ¯ç«¯/å­è´¦å·æƒé™æ§åˆ¶

- [ ] **AIèŠä¹¦**ï¼ˆé˜¶æ®µäºŒï¼‰
  - [ ] éŸ³è‰²é€‰æ‹©ï¼šåˆ‡æ¢ã€å®æ—¶ç”Ÿæ•ˆ
  - [ ] å†å²è®°å½•ï¼šæŠ˜å /å±•å¼€ã€æœ¬åœ°ç¼“å­˜

- [ ] **å¬ä¹¦-AIäº¤äº’**ï¼ˆé˜¶æ®µäºŒï¼‰
  - [ ] æˆè¯­å¡«ç©ºï¼šé¢˜ç›®æ¨é€ã€ç­”é¢˜ã€åé¦ˆ
  - [ ] é˜…è¯»ç†è§£ï¼šæé—®ã€ä½œç­”ã€è¯„åˆ†
  - [ ] èŠä¹¦äº’åŠ¨ï¼šå¼•å¯¼é—®é¢˜ã€ç‚¹å‡»è§¦å‘

#### 13.1.2 P1 åŠŸèƒ½ï¼ˆé‡Œç¨‹ç¢‘äºŒï¼‰

- [ ] **å¾®ä¿¡çŠ¶æ€ä¸åˆ†äº«**
  - [ ] å£ä»¤ç”Ÿæˆï¼šå†…å®¹ã€è¯é¢˜ã€èƒŒæ™¯
  - [ ] å¾®ä¿¡çŠ¶æ€è®¾ç½®ï¼šè°ƒç ”æ¥å£å¯è¡Œæ€§
  - [ ] æœ‹å‹åœˆåˆ†äº«ï¼šæµ·æŠ¥ç”Ÿæˆã€ä¿å­˜ã€åˆ†äº«

- [ ] **AIæ¨ä¹¦**
  - [ ] æ™ºèƒ½æ¨ä¹¦ï¼šè¾“å…¥éœ€æ±‚ã€æµå¼è¾“å‡º
  - [ ] çŒœä½ å–œæ¬¢ï¼šé¦–é¡µå…¥å£ã€æ¨èåˆ—è¡¨
  - [ ] æ¨èä¹¦ç±å¡ç‰‡ï¼šç‚¹å‡»è·³è½¬

- [ ] **å­¦ä¹ æ¿€åŠ±**
  - [ ] æ¿€åŠ±ä¸­å¿ƒï¼šç§¯åˆ†/æ˜Ÿæ˜Ÿå±•ç¤ºã€æ˜ç»†
  - [ ] Flagæ‰“å¡ï¼šè®¾ç½®ç›®æ ‡ã€æ¯æ—¥æ‰“å¡
  - [ ] è™šæ‹Ÿå‹‹ç« ï¼šè§£é”ã€ä¿å­˜ã€åˆ†äº«

#### 13.1.3 P2 åŠŸèƒ½ï¼ˆé‡Œç¨‹ç¢‘äºŒï¼‰

- [ ] **é˜²æ²‰è¿·ç³»ç»Ÿ**
  - [ ] AIä½¿ç”¨æ¬¡æ•°é™åˆ¶ï¼šå®¶é•¿è®¾ç½®ã€å­è´¦å·ç”Ÿæ•ˆ
  - [ ] é˜…è¯»æ—¶é•¿é™åˆ¶ï¼šç»Ÿè®¡ã€æé†’ã€å¼ºåˆ¶åœæ­¢

- [ ] **æ•°æ®ç»Ÿè®¡**
  - [ ] ç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹ï¼šä¸ŠæŠ¥ã€æŸ¥çœ‹
  - [ ] ç®¡ç†åå°ï¼šAIéŸ³è‰²ç»Ÿè®¡ã€å¬ä¹¦ç»Ÿè®¡

### 13.2 å…¼å®¹æ€§æµ‹è¯•

- [ ] iOSï¼šiPhone 8 åŠä»¥ä¸Šã€iOS 13 åŠä»¥ä¸Š
- [ ] Androidï¼šä¸»æµæœºå‹ã€Android 8 åŠä»¥ä¸Š
- [ ] å¾®ä¿¡ç‰ˆæœ¬ï¼šæœ€æ–°ç‰ˆæœ¬åŠå‰ä¸¤ä¸ªç‰ˆæœ¬
- [ ] ç½‘ç»œç¯å¢ƒï¼š4Gã€5Gã€WiFiã€å¼±ç½‘

### 13.3 æ€§èƒ½æµ‹è¯•æŒ‡æ ‡

- [ ] é¦–å±åŠ è½½æ—¶é—´ < 3s
- [ ] é¡µé¢åˆ‡æ¢æµç•…åº¦ > 50 FPS
- [ ] AI èŠä¹¦é¦–æ¬¡å“åº” < 2s
- [ ] å›¾ç‰‡æ‡’åŠ è½½ç”Ÿæ•ˆ
- [ ] å†…å­˜å ç”¨ < 200MB

### 13.4 å®‰å…¨æµ‹è¯•

- [ ] æ¥å£ç­¾åéªŒè¯
- [ ] Token è¿‡æœŸå¤„ç†
- [ ] æ•æ„Ÿä¿¡æ¯åŠ å¯†
- [ ] é˜²é‡æ”¾æ”»å‡»
- [ ] æƒé™æ§åˆ¶ï¼ˆå¤šè§’è‰²éš”ç¦»ï¼‰

---

## 14. ä¸Šçº¿å‘å¸ƒæµç¨‹

### 14.1 å‘å¸ƒæµç¨‹æ€»è§ˆ

```mermaid
flowchart TD
    A[ä»£ç å¼€å‘å®Œæˆ] --> B[ä»£ç å®¡æŸ¥<br/>Code Review]
    B --> C[åˆå¹¶åˆ°ä¸»åˆ†æ”¯<br/>git merge]
    C --> D[é¢„å‘å¸ƒæ£€æŸ¥]
    
    D --> D1[ç§»é™¤è°ƒè¯•ä»£ç ]
    D --> D2[æ£€æŸ¥èµ„æºCDNåŒ–]
    D --> D3[æ£€æŸ¥æ•æ„Ÿä¿¡æ¯]
    D --> D4[æ›´æ–°ç‰ˆæœ¬å·]
    
    D1 --> E[æ„å»ºç”Ÿäº§åŒ…<br/>npm run build]
    D2 --> E
    D3 --> E
    D4 --> E
    
    E --> F[ä¸Šä¼ åˆ°å¾®ä¿¡åå°<br/>å¼€å‘å·¥å…·ä¸Šä¼ ]
    F --> G[æäº¤å®¡æ ¸]
    
    G --> H{å®¡æ ¸ç»“æœ}
    H -->|å®¡æ ¸é€šè¿‡| I[è®¾ç½®ç°åº¦å‘å¸ƒ]
    H -->|å®¡æ ¸æ‹’ç»| J[ä¿®æ”¹é—®é¢˜]
    
    J --> K[é‡æ–°æäº¤å®¡æ ¸]
    K --> H
    
    I --> L[ç°åº¦é˜¶æ®µä¸€<br/>5%ç”¨æˆ·/3å¤©]
    L --> M{ç›‘æ§æŒ‡æ ‡æ­£å¸¸?}
    
    M -->|å¼‚å¸¸| N[ç´§æ€¥å›æ»š]
    M -->|æ­£å¸¸| O[ç°åº¦é˜¶æ®µäºŒ<br/>20%ç”¨æˆ·/2å¤©]
    
    O --> P{ç›‘æ§æŒ‡æ ‡æ­£å¸¸?}
    P -->|å¼‚å¸¸| N
    P -->|æ­£å¸¸| Q[å…¨é‡å‘å¸ƒ<br/>100%ç”¨æˆ·]
    
    Q --> R[å‘å¸ƒæˆåŠŸé€šçŸ¥]
    N --> S[ä¿®å¤é—®é¢˜]
    S --> J
```

### 14.1 é¢„å‘å¸ƒæ£€æŸ¥

1. **ä»£ç å®¡æŸ¥**
   - [ ] ç§»é™¤æ‰€æœ‰ `console.log`
   - [ ] ç§»é™¤è°ƒè¯•ä»£ç 
   - [ ] æ£€æŸ¥æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keyã€Secretï¼‰

2. **èµ„æºæ£€æŸ¥**
   - [ ] æ‰€æœ‰å›¾ç‰‡å·²ä¸Šä¼  CDN
   - [ ] å­—ä½“æ–‡ä»¶å·²ä¸Šä¼  CDN
   - [ ] åŸŸåå·²é…ç½®ç™½åå•

3. **åŠŸèƒ½æ£€æŸ¥**
   - [ ] æ‰€æœ‰ P0 åŠŸèƒ½æµ‹è¯•é€šè¿‡
   - [ ] å¾®ä¿¡å®¡æ ¸å¯èƒ½çš„é—®é¢˜ç‚¹å·²è§„é¿
   - [ ] ç”¨æˆ·åè®®ã€éšç§æ”¿ç­–å·²æ›´æ–°

### 14.2 ç‰ˆæœ¬ç®¡ç†

```javascript
// configs/version.js
export const VERSION_INFO = {
  version: '1.0.0',
  buildTime: '2026-02-06 10:00:00',
  changelog: [
    'âœ¨ AIèŠä¹¦ï¼šæ”¯æŒè‡ªå®šä¹‰éŸ³è‰²',
    'âœ¨ AIæ¨ä¹¦ï¼šæ™ºèƒ½æ¨èç³»ç»Ÿä¸Šçº¿',
    'âœ¨ å­¦ä¹ æ¿€åŠ±ï¼šè™šæ‹Ÿå‹‹ç« ç³»ç»Ÿ',
    'ğŸ› ä¿®å¤ï¼šé˜…è¯»è¿›åº¦åŒæ­¥é—®é¢˜',
    'âš¡ ä¼˜åŒ–ï¼šé¦–å±åŠ è½½é€Ÿåº¦æå‡30%'
  ]
}
```

### 14.3 ç°åº¦å‘å¸ƒç­–ç•¥

1. **ç°åº¦é˜¶æ®µä¸€**ï¼š5% ç”¨æˆ·ï¼Œç›‘æ§ 3 å¤©
2. **ç°åº¦é˜¶æ®µäºŒ**ï¼š20% ç”¨æˆ·ï¼Œç›‘æ§ 2 å¤©
3. **å…¨é‡å‘å¸ƒ**ï¼š100% ç”¨æˆ·

### 14.4 ç›‘æ§ä¸åº”æ€¥

#### 14.4.1 ç›‘æ§ä½“ç³»æ¶æ„

```mermaid
flowchart TD
    A[ç›‘æ§ç³»ç»Ÿ] --> B[æ€§èƒ½ç›‘æ§]
    A --> C[é”™è¯¯ç›‘æ§]
    A --> D[ä¸šåŠ¡ç›‘æ§]
    A --> E[ç”¨æˆ·åé¦ˆç›‘æ§]
    
    B --> B1[é¦–å±åŠ è½½æ—¶é•¿<br/>ç›®æ ‡ï¼š< 3ç§’]
    B --> B2[é¡µé¢FPS<br/>ç›®æ ‡ï¼š> 50]
    B --> B3[æ¥å£å“åº”æ—¶é—´<br/>ç›®æ ‡ï¼š< 2ç§’]
    B --> B4[å†…å­˜å ç”¨<br/>ç›®æ ‡ï¼š< 200MB]
    
    C --> C1[JSé”™è¯¯ç‡<br/>ç›®æ ‡ï¼š< 0.5%]
    C --> C2[æ¥å£å¤±è´¥ç‡<br/>ç›®æ ‡ï¼š< 1%]
    C --> C3[å´©æºƒç‡<br/>ç›®æ ‡ï¼š< 0.1%]
    
    D --> D1[AIæœåŠ¡å¯ç”¨ç‡<br/>ç›®æ ‡ï¼š> 95%]
    D --> D2[æ—¥æ´»/ç•™å­˜ç‡]
    D --> D3[æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨ç‡]
    
    E --> E1[ç”¨æˆ·æŠ•è¯‰<br/>ç›®æ ‡ï¼š< 0.5%]
    E --> E2[åº”ç”¨å•†åº—è¯„åˆ†<br/>ç›®æ ‡ï¼š> 4.5]
    
    B1 --> F[å‘Šè­¦è§¦å‘]
    B2 --> F
    B3 --> F
    C1 --> F
    C2 --> F
    C3 --> F
    D1 --> F
    
    F --> G{ä¸¥é‡ç¨‹åº¦}
    G -->|P0ä¸¥é‡| H[ç«‹å³é€šçŸ¥<br/>ç”µè¯+çŸ­ä¿¡]
    G -->|P1é‡è¦| I[5åˆ†é’Ÿå†…é€šçŸ¥<br/>ä¼ä¸šå¾®ä¿¡]
    G -->|P2ä¸€èˆ¬| J[æ—¥æŠ¥æ±‡æ€»]
    
    H --> K[åº”æ€¥å“åº”]
    I --> K
```

#### 14.4.2 åº”æ€¥å›æ»šæµç¨‹

```mermaid
flowchart TD
    A[ç›‘æ§å‘Šè­¦è§¦å‘<br/>P0ä¸¥é‡é—®é¢˜] --> B[ç ”å‘å›¢é˜Ÿå“åº”<br/>5åˆ†é’Ÿå†…]
    B --> C[é—®é¢˜å®šä½]
    
    C --> D{èƒ½å¿«é€Ÿä¿®å¤?}
    D -->|æ˜¯ é¢„è®¡<30åˆ†é’Ÿ| E[ç´§æ€¥ä¿®å¤]
    D -->|å¦| F[å†³å®šå›æ»š]
    
    E --> G[æœ¬åœ°ä¿®å¤éªŒè¯]
    G --> H[å¿«é€Ÿå‘ç‰ˆ]
    H --> I[ç°åº¦10%éªŒè¯]
    I --> J{é—®é¢˜è§£å†³?}
    
    J -->|æ˜¯| K[å…¨é‡å‘å¸ƒ]
    J -->|å¦| F
    
    F --> L[å‡†å¤‡å›æ»š]
    L --> M[é€šçŸ¥è¿è¥/å®¢æœ<br/>å‡†å¤‡ç”¨æˆ·å…¬å‘Š]
    M --> N[å¾®ä¿¡åå°æ“ä½œ<br/>å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬]
    N --> O[å…¨é‡ç”Ÿæ•ˆ<br/>é¢„è®¡10åˆ†é’Ÿ]
    O --> P[éªŒè¯å›æ»šæ•ˆæœ]
    P --> Q{é—®é¢˜è§£å†³?}
    
    Q -->|æ˜¯| R[äº‹åå¤ç›˜<br/>é—®é¢˜æ€»ç»“]
    Q -->|å¦| S[ç»§ç»­æ’æŸ¥<br/>å‡çº§åº”æ€¥ç­‰çº§]
    
    R --> T[ä¼˜åŒ–ç›‘æ§ç­–ç•¥<br/>é˜²æ­¢å†æ¬¡å‘ç”Ÿ]
```

#### 14.4.3 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

```mermaid
flowchart TD
    A[ç‰ˆæœ¬å‘½åè§„èŒƒ] --> B[ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢å·]
    B --> C[ç¤ºä¾‹ï¼š1.2.3]
    
    C --> D[ä¸»ç‰ˆæœ¬ 1<br/>é‡å¤§æ¶æ„å˜æ›´]
    C --> E[æ¬¡ç‰ˆæœ¬ 2<br/>æ–°åŠŸèƒ½å‘å¸ƒ]
    C --> F[ä¿®è®¢å· 3<br/>Bugä¿®å¤]
    
    G[Gitæ ‡ç­¾ç®¡ç†] --> H[å‘å¸ƒæ—¶æ‰“æ ‡ç­¾<br/>git tag v1.2.3]
    H --> I[æ¨é€æ ‡ç­¾<br/>git push origin v1.2.3]
    I --> J[æ ‡ç­¾å¯¹åº”çº¿ä¸Šç‰ˆæœ¬<br/>æ”¯æŒå¿«é€Ÿå›æ»š]
    
    K[åˆ†æ”¯ç­–ç•¥] --> L[masterä¸»åˆ†æ”¯<br/>çº¿ä¸Šç‰ˆæœ¬]
    K --> M[developå¼€å‘åˆ†æ”¯<br/>é›†æˆæµ‹è¯•]
    K --> N[feature/xxxåŠŸèƒ½åˆ†æ”¯<br/>åŠŸèƒ½å¼€å‘]
    K --> O[hotfix/xxxä¿®å¤åˆ†æ”¯<br/>ç´§æ€¥ä¿®å¤]
    
    N --> P[åˆå¹¶åˆ°develop]
    P --> Q[æµ‹è¯•é€šè¿‡]
    Q --> R[åˆå¹¶åˆ°master]
    R --> S[æ‰“æ ‡ç­¾å‘å¸ƒ]
    
    O --> T[ç›´æ¥åˆå¹¶åˆ°master]
    T --> U[ç´§æ€¥å‘å¸ƒ]
    U --> V[å›åˆåˆ°develop]
```

---

## 15. é™„å½•

### 15.1 æŠ€æœ¯æ ˆæ€»ç»“

- **æ¡†æ¶**ï¼šå¾®ä¿¡åŸç”Ÿå°ç¨‹åº
- **ç½‘ç»œè¯·æ±‚**ï¼šå°è£… `wx.request`ï¼Œæ”¯æŒç­¾åã€é‡è¯•ã€SSE
- **çŠ¶æ€ç®¡ç†**ï¼šæœ¬åœ° Storage + å…¨å±€ globalData
- **AI èƒ½åŠ›**ï¼šSSE æµå¼ä¼ è¾“ã€å¤šæ¨¡æ€ç”Ÿæˆï¼ˆæ–‡æœ¬/å›¾ç‰‡/éŸ³é¢‘ï¼‰
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ†åŒ…ã€è™šæ‹Ÿåˆ—è¡¨ã€setData ä¼˜åŒ–ã€èµ„æºæ‡’åŠ è½½
- **æ•°æ®ç»Ÿè®¡**ï¼šè‡ªç ”åŸ‹ç‚¹ç³»ç»Ÿ

### 15.2 ç¬¬ä¸‰æ–¹ä¾èµ–

```json
{
  "dependencies": {
    "crypto-js": "^4.1.1",
    "@vant/weapp": "^1.10.0"
  }
}
```

### 15.3 å¼€å‘è§„èŒƒ

#### 15.3.1 å‘½åè§„èŒƒ

- é¡µé¢ï¼šå°å†™çŸ­æ¨ªçº¿ï¼ˆ`ai-chat.js`ï¼‰
- ç»„ä»¶ï¼šå°å†™çŸ­æ¨ªçº¿ï¼ˆ`book-card.js`ï¼‰
- å‡½æ•°ï¼šå°é©¼å³°ï¼ˆ`loadBookInfo`ï¼‰
- å¸¸é‡ï¼šå¤§å†™ä¸‹åˆ’çº¿ï¼ˆ`MAX_AI_USAGE`ï¼‰

#### 15.3.2 æ³¨é‡Šè§„èŒƒ

```javascript
/**
 * å‡½æ•°åŠŸèƒ½æè¿°
 * @param {ç±»å‹} å‚æ•°å - å‚æ•°è¯´æ˜
 * @returns {ç±»å‹} è¿”å›å€¼è¯´æ˜
 */
```

#### 15.3.3 Git æäº¤è§„èŒƒ

```bash
feat: æ–°å¢ AI æ¨ä¹¦åŠŸèƒ½
fix: ä¿®å¤éŸ³è‰²æ’­æ”¾å¼‚å¸¸
perf: ä¼˜åŒ–é¦–å±åŠ è½½é€Ÿåº¦
docs: æ›´æ–°æŠ€æœ¯æ–‡æ¡£
```

---

## 16. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 16.1 SSE è¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šAI èŠä¹¦æ—¶æµå¼è¾“å‡ºä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åŸŸåæ˜¯å¦åœ¨ request ç™½åå•
2. å¢åŠ  timeout æ—¶é•¿åˆ° 60s
3. å®ç°æ–­çº¿é‡è¿æœºåˆ¶
4. é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šæ¥å£è½®è¯¢

### 16.2 éŸ³è‰²ä¸Šä¼ å¤±è´¥

**é—®é¢˜**ï¼šå½•éŸ³ä¸Šä¼ è¶…æ—¶æˆ–å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ uploadFile åŸŸåé…ç½®
2. é™åˆ¶å½•éŸ³æ—¶é•¿ < 60s
3. å‹ç¼©éŸ³é¢‘ï¼ˆé™ä½é‡‡æ ·ç‡ï¼‰
4. æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡

### 16.3 å›¾ç‰‡ç”Ÿæˆæ…¢

**é—®é¢˜**ï¼šAI æ’ç”»ç”Ÿæˆè¶…è¿‡ 60s

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å¼‚æ­¥ç”Ÿæˆ
2. è½®è¯¢æŸ¥è¯¢ç”ŸæˆçŠ¶æ€
3. æ˜¾ç¤ºç”Ÿæˆè¿›åº¦åŠ¨ç”»
4. æä¾›å–æ¶ˆåŠŸèƒ½

### 16.4 é˜²æ²‰è¿·ç»•è¿‡

**é—®é¢˜**ï¼šç”¨æˆ·é€šè¿‡åˆ‡æ¢è§’è‰²ç»•è¿‡é™åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åç«¯æŒ‰è®¾å¤‡ç»´åº¦ç»Ÿè®¡
2. é™åˆ¶æ¯æ—¥åˆ‡æ¢è§’è‰²æ¬¡æ•°
3. å®¶é•¿ç«¯æ¥æ”¶å¼‚å¸¸è¡Œä¸ºé€šçŸ¥

---

## 17. æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ€»è§ˆ

### 17.1 ç”¨æˆ·ä½¿ç”¨å®Œæ•´æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·æ‰“å¼€å°ç¨‹åº] --> B{é¦–æ¬¡ä½¿ç”¨?}
    B -->|æ˜¯| C[å¾®ä¿¡æˆæƒç™»å½•]
    B -->|å¦| D[è¯»å–æœ¬åœ°token]
    
    C --> E[åˆ›å»ºè´¦å·]
    E --> F[åˆ›å»ºè§’è‰²<br/>å®¶é•¿/å­©å­]
    F --> G[è¿›å…¥é¦–é¡µ]
    
    D --> H{tokenæœ‰æ•ˆ?}
    H -->|æ˜¯| G
    H -->|å¦| C
    
    G --> I[é¦–é¡µåŠŸèƒ½]
    I --> I1[æµè§ˆä¹¦ç±åˆ—è¡¨]
    I --> I2[çŒœä½ å–œæ¬¢]
    I --> I3[AIæ¨ä¹¦å…¥å£]
    I --> I4[AIåˆ›ä½œå…¥å£]
    
    I1 --> J[ç‚¹å‡»ä¹¦ç±]
    J --> K[ä¹¦ç±è¯¦æƒ…é¡µ]
    K --> L[å¼€å§‹å¬ä¹¦]
    
    L --> M[å¬ä¹¦åŠŸèƒ½]
    M --> M1[é€‰æ‹©AIéŸ³è‰²]
    M --> M2[AIæ™ºèƒ½ä½“äº¤äº’<br/>æˆè¯­å¡«ç©º/é˜…è¯»ç†è§£]
    M --> M3[AIèŠä¹¦]
    M --> M4[é˜…è¯»æ—¶é•¿ç»Ÿè®¡<br/>æ¯10åˆ†é’Ÿå¥–åŠ±]
    
    I3 --> N[AIæ¨ä¹¦]
    N --> O[è¾“å…¥éœ€æ±‚]
    O --> P[SSEæµå¼è¿”å›æ¨è]
    P --> Q[æ¨èä¹¦ç±å¡ç‰‡]
    Q --> K
    
    I4 --> R[AIåˆ›ä½œ]
    R --> R1[æƒ…èŠ‚ä»¿å†™]
    R --> R2[æƒ…èŠ‚æ’ç”»]
    R --> R3[è§’è‰²å½¢è±¡]
    R --> R4[æ’­å®¢éŸ³é¢‘]
    
    M4 --> S[è·å¾—ç§¯åˆ†æ˜Ÿæ˜Ÿ]
    S --> T[æ¿€åŠ±ä¸­å¿ƒ]
    T --> U[å…‘æ¢å‹‹ç« ]
    U --> V[åˆ†äº«æˆå°±]
    
    V --> W[ç”Ÿæˆåˆ†äº«æµ·æŠ¥/å¾®ä¿¡çŠ¶æ€]
    W --> X[åˆ†äº«åˆ°å¾®ä¿¡ç”Ÿæ€]
```

### 17.2 æŠ€æœ¯æ¶æ„æµç¨‹

```mermaid
flowchart TD
    A[å°ç¨‹åºå‰ç«¯] --> B[ç½‘ç»œå±‚]
    B --> C[åç«¯æœåŠ¡]
    C --> D[AIæœåŠ¡]
    C --> E[å­˜å‚¨æœåŠ¡]
    C --> F[CDNæœåŠ¡]
    
    B --> B1[è¯·æ±‚å°è£…<br/>ç­¾å/é‡è¯•/ç¼“å­˜]
    B --> B2[SSEæµå¼å¤„ç†<br/>AIå¯¹è¯]
    B --> B3[æ–‡ä»¶ä¸Šä¼ <br/>éŸ³è‰²/å›¾ç‰‡]
    
    D --> D1[AIèŠä¹¦æ™ºèƒ½ä½“]
    D --> D2[AIæ¨ä¹¦æ™ºèƒ½ä½“]
    D --> D3[AIåˆ›ä½œæ™ºèƒ½ä½“<br/>ä»¿å†™/æ’ç”»/è§’è‰²/æ’­å®¢]
    
    E --> E1[ç”¨æˆ·æ•°æ®<br/>MySQL]
    E --> E2[é˜…è¯»è¿›åº¦<br/>Redis]
    E --> E3[ç»Ÿè®¡æ•°æ®<br/>ClickHouse]
    
    F --> F1[ä¹¦ç±å°é¢<br/>å›¾ç‰‡CDN]
    F --> F2[éŸ³è‰²æ–‡ä»¶<br/>éŸ³é¢‘CDN]
    F --> F3[å­—ä½“æ–‡ä»¶<br/>é™æ€CDN]
    
    G[æ•°æ®æµå‘] --> H[ç”¨æˆ·æ“ä½œ]
    H --> I[åŸ‹ç‚¹ä¸ŠæŠ¥]
    I --> J[æ•°æ®ç»Ÿè®¡]
    J --> K[ç®¡ç†åå°]
    K --> L[æ•°æ®åˆ†æ<br/>ä¼˜åŒ–è¿­ä»£]
```

## 17. æ€»ç»“

æœ¬æŠ€æœ¯æ–¹æ¡ˆåŸºäºã€Œä¼é¹…è¯»ä¼´ã€é¡¹ç›®çš„å®é™…ä¸šåŠ¡éœ€æ±‚ï¼Œæä¾›äº†ä»é¡¹ç›®åˆå§‹åŒ–åˆ°ä¸Šçº¿å‘å¸ƒçš„å®Œæ•´å®æ–½è·¯å¾„ï¼Œæ¶µç›–ï¼š

âœ… **æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½**ï¼šAI èŠä¹¦ã€AI æ¨ä¹¦ã€AI åˆ›ä½œã€AI éŸ³è‰²ã€å­¦ä¹ æ¿€åŠ±ã€å¤šè§’è‰²ç®¡ç†  
âœ… **æŠ€æœ¯å®ç°**ï¼šSSE æµå¼ä¼ è¾“ã€éŸ³è‰²å½•åˆ¶ä¸Šä¼ ã€Canvas æµ·æŠ¥ç”Ÿæˆã€æ•°æ®åŸ‹ç‚¹  
âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šé¦–å±ç¼“å­˜ã€åˆ†åŒ…åŠ è½½ã€è™šæ‹Ÿåˆ—è¡¨ã€setData ä¼˜åŒ–  
âœ… **å®‰å…¨åˆè§„**ï¼šæ¥å£ç­¾åã€æƒé™æ§åˆ¶ã€é˜²æ²‰è¿·ç³»ç»Ÿã€éšç§ä¿æŠ¤  
âœ… **è¿ç»´ä¿éšœ**ï¼šç°åº¦å‘å¸ƒã€ç›‘æ§å‘Šè­¦ã€åº”æ€¥å›æ»š  
âœ… **æµç¨‹å›¾å®Œæ•´**ï¼š60+ ä¸šåŠ¡æµç¨‹å›¾ï¼Œæ¸…æ™°å±•ç¤ºæŠ€æœ¯å®ç°é€»è¾‘

**å…³é”®æ³¨æ„äº‹é¡¹**ï¼š
1. å¾®ä¿¡çŠ¶æ€è®¾ç½®åŠŸèƒ½éœ€è°ƒç ”æ¥å£å¯è¡Œæ€§ï¼Œå¯èƒ½éœ€è¦å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
2. AI å›¾ç‰‡/éŸ³é¢‘ç”Ÿæˆè€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦å¼‚æ­¥ä»»åŠ¡ + è½®è¯¢æœºåˆ¶
3. å¤šè§’è‰²è´¦å·ä½“ç³»éœ€ä¸¥æ ¼åšå¥½æ•°æ®éš”ç¦»ä¸æƒé™æ§åˆ¶
4. SSE æµå¼ä¼ è¾“éœ€å……åˆ†æµ‹è¯•å¼±ç½‘ç¯å¢ƒçš„ç¨³å®šæ€§
5. é˜²æ²‰è¿·ç³»ç»Ÿéœ€å‰åç«¯é…åˆï¼Œé¿å…è¢«ç»•è¿‡

**æµç¨‹å›¾ç´¢å¼•**ï¼š
- ç¬¬0ç« ï¼šé¡¹ç›®æ¦‚è¿°ä¸ä¸šåŠ¡éœ€æ±‚åˆ†æ
- ç¬¬10.1èŠ‚ï¼šAIéŸ³è‰²ç®¡ç†æµç¨‹ï¼ˆå½•åˆ¶ã€åˆ†äº«ã€æ¥æ”¶ã€åº”ç”¨ï¼‰
- ç¬¬10.2èŠ‚ï¼šå­¦ä¹ æ¿€åŠ±ç³»ç»Ÿæµç¨‹ï¼ˆæ¿€åŠ±æ¶æ„ã€é˜…è¯»å¥–åŠ±ã€å‹‹ç« å…‘æ¢ã€Flagæ‰“å¡ï¼‰
- ç¬¬10.3èŠ‚ï¼šå¤šè§’è‰²è´¦å·ç®¡ç†æµç¨‹ï¼ˆæ¶æ„ã€åˆ‡æ¢ã€æƒé™ã€æ•°æ®éš”ç¦»ï¼‰
- ç¬¬10.4èŠ‚ï¼šå¾®ä¿¡çŠ¶æ€ä¸åˆ†äº«æµç¨‹ï¼ˆæœ‹å‹åœˆæµ·æŠ¥ã€å¾®ä¿¡çŠ¶æ€ç”Ÿæˆï¼‰
- ç¬¬10.5èŠ‚ï¼šé˜²æ²‰è¿·ç³»ç»Ÿæµç¨‹ï¼ˆæ¶æ„ã€æ£€æŸ¥ã€å®¶é•¿è®¾ç½®ï¼‰
- ç¬¬10.6èŠ‚ï¼šæ•°æ®ç»Ÿè®¡ä¸åŸ‹ç‚¹æµç¨‹ï¼ˆæ¶æ„ã€ä¸šåŠ¡åŸ‹ç‚¹ã€æŠ¥è¡¨åº”ç”¨ï¼‰
- ç¬¬10.7èŠ‚ï¼šAIåˆ›ä½œåŠŸèƒ½æµç¨‹ï¼ˆä»¿å†™ã€æ’ç”»ã€è§’è‰²ã€æ’­å®¢ï¼‰
- ç¬¬12ç« ï¼šæ€§èƒ½ä¼˜åŒ–æµç¨‹ï¼ˆé¦–å±åŠ è½½ã€é•¿åˆ—è¡¨ã€setDataã€åˆ†åŒ…ï¼‰
- ç¬¬13ç« ï¼šæµ‹è¯•ä¸éªŒæ”¶æµç¨‹
- ç¬¬14ç« ï¼šä¸Šçº¿å‘å¸ƒæµç¨‹ï¼ˆå‘å¸ƒã€ç›‘æ§ã€åº”æ€¥å›æ»šï¼‰
- ç¬¬17ç« ï¼šæ ¸å¿ƒä¸šåŠ¡æµç¨‹æ€»è§ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0ï¼ˆæµç¨‹å›¾ä¼˜åŒ–ç‰ˆï¼‰  
**æ›´æ–°æ—¥æœŸ**ï¼š2026-02-06  
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šä¼é¹…è¯»ä¼´ç ”å‘å›¢é˜Ÿ
